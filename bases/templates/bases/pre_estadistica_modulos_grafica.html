{% extends "base/base.html" %}
{% load static %}
<title>{% block title %} Módulos Gráfica :: Estadistica {% endblock %} </title>
{% block wrapper %}
<div class="container mt-3">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4 pb-1">
                <div class="row">
                    <div class="col-xl-1 col-lg-1 col-md-3 col-sm-12 col-12">
                        <img
                        src="{% static "base/img/Icon/grafico_n.png" %}"
                        alt="Estadistica"
                        class="d-block m-2" width="65" height="65" />
                    </div>

                    <div class="col-xl-11 col-lg-11 col-md-9 col-sm-12 col-12">
                        <h4 class="mb-0 mt-2 d-flex justify-content-start">Estadística por Organo Jurisdiccional</h4>
                        <h6> <a href="{% url "bases:presidencia" %}">Tablero de Control </a><span> <a href="{% url "bases:estadistica_menu" %}">/ Estadística </a></span><span>/ Estadística por Órgano Jurisdiccional </span></h6>
                    </div>
                </div>
            </div>
        </div>
    </div> 

    <div clss="row">
        <div class="col-12">
            <div class="nav-align-top nav-tabs-shadow mb-6">
                {% comment "" %} =======================================
                =============== CABECERAS DEL PANEL ====================
                ======================================= {% endcomment %}
                <ul class="nav nav-tabs nav-fill" role="tablist">
                    {% comment "" %} =======================================
                    ================== GRAFICO GENERAL =====================
                    ======================================= {% endcomment %}
                    <li class="nav-item">
                        <button type="button" class="nav-link active" role="tab" data-bs-toggle="tab" data-bs-target="#navs-justified-home" aria-controls="navs-justified-home" aria-selected="true">
                            <span class="d-none d-sm-block"> Grafico General</span>
                        </button>
                    </li>

                    {% comment "" %} =======================================
                    =========== AVANCE DE META POR ORG. JURISD. ============
                    ======================================= {% endcomment %}
                    <li class="nav-item">
                        <button type="button" class="nav-link" role="tab" data-bs-toggle="tab" data-bs-target="#navs-justified-profile" aria-controls="navs-justified-profile" aria-selected="false">
                            <span class="d-none d-sm-block">Avance de Meta por Org. Jurisdiccional</span>
                        </button>
                    </li>

                    {% comment "" %} =======================================
                    ======== EXPEDIENTE INGRESADOS VS RESUELTOS ============
                    ======================================= {% endcomment %}
                    <li class="nav-item">
                        <button type="button" class="nav-link" role="tab" data-bs-toggle="tab" data-bs-target="#navs-justified-messages" aria-controls="navs-justified-messages" aria-selected="false">
                            <span class="d-none d-sm-block">
                                Expedientes Ingresados VS Resueltos
                            </span>
                        </button>
                    </li>
                </ul>

                {% comment %} =======================================
                ================= CUERPO DEL PANEL =====================
                ======================================= {% endcomment %}
                <div class="tab-content pt-2">
                    {% comment "" %} =======================================
                    ======= CUERPO 01: GRAFICO POR PORCENTAJE ==============
                    ======================================= {% endcomment %}
                    <div class="tab-pane fade show active" id="navs-justified-home" role="tabpanel">
                        <div class="col-lg-12 col-12">
                        {% for jurisdiccion, instancias in agrupados.items %}
                            <h3 class="text-center mt-5 font-weight-bold">RANKING DE {{ jurisdiccion }}</h3>
                            <canvas  id="graficoBarras_{{ forloop.counter }}"></canvas>

                            <script id="data_{{ forloop.counter }}" type="application/json">
                                {{ instancias|safe }}
                            </script>
                            <script>
                            document.addEventListener("DOMContentLoaded", function() {    
                                const labels_{{ forloop.counter }} = {{ instancias|safe }}.map(i => i.n_instancia__x_nom_instancia);
                                const x_corto_{{ forloop.counter }} = {{ instancias|safe }}.map(i => i.n_instancia__x_corto); // Extraer x_corto
                                const nombre_instancia_{{ forloop.counter }} = {{ instancias|safe }}.map(i => i.n_instancia__x_nom_instancia);
                                const avance_{{ forloop.counter }} = {{ instancias|safe }}.map(i => parseFloat(i.m_avan_meta));
                                const ideal_avance_{{ forloop.counter }} = {{ instancias|safe }}.map(i => parseFloat(i.m_ideal_avan_meta));
                        
                                // Generar colores dinámicos
                                const backgroundColors_{{ forloop.counter }} = avance_{{ forloop.counter }}.map((valor, index) => {
                                    return valor < ideal_avance_{{ forloop.counter }}[index] 
                                        ? 'rgba(255, 99, 132, 0.5)' // Rojo si está por debajo de la meta
                                        : 'rgba(75, 192, 192, 0.5)'; // Verde si cumple o supera la meta
                                });

                                // Registrar el plugin antes de usarlo
                                Chart.register(ChartDataLabels);
                    
                                // Obtener el contexto del canvas
                                const ctx_{{ forloop.counter }} = document.getElementById('graficoBarras_{{ forloop.counter }}').getContext('2d');
                                new Chart(ctx_{{ forloop.counter }}, {
                                    type: 'bar',
                                    data: {
                                        labels: labels_{{ forloop.counter }},
                                        datasets: [{
                                            label: '% Porcentaje de Avance de Meta Mensual',
                                            data: avance_{{ forloop.counter }},
                                            backgroundColor: backgroundColors_{{ forloop.counter }},
                                            borderColor: backgroundColors_{{ forloop.counter }}.map(color => color.replace('0.5', '1')),
                                            borderWidth: 1
                                        }]
                                    },
                                    options: {
                                        indexAxis: 'y',
                                        responsive: true,
                                        plugins: {
                                            legend: {
                                                labels: {
                                                    generateLabels: function(chart) {
                                                        let original = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                                        original.push({
                                                            text: 'Línea de Referencia 27%',
                                                            fillStyle: 'rgba(24, 85, 216, 0.4)',
                                                            strokeStyle: 'rgba(24, 85, 216, 0.4)',
                                                            lineWidth: 1,
                                                            hidden: false
                                                        });
                                                        return original;
                                                    }
                                                }
                                            },
                                            datalabels: {
                                                anchor: 'center',  // Ancla en el extremo derecho
                                                align: 'center',  // Centra el texto dentro de la barra
                                                formatter: (value) => `${value}%`,
                                                color: 'black',  // Color del texto
                                                font: {
                                                    size: 14,
                                                    weight: 'bold',
                                                },
                                                clip: false // Evita que el texto se recorte si la barra es pequeña
                                            },
                                            tooltip: {
                                                callbacks: {
                                                    label: function(tooltipItem) {
                                                        let index = tooltipItem.dataIndex;
                                                        let corto = x_corto_{{ forloop.counter }}[index];
                                                        let avanceReal = avance_{{ forloop.counter }}[index];
                                                        let ideal = ideal_avance_{{ forloop.counter }}[index];
                                                        let nombre_instancia = nombre_instancia_{{ forloop.counter }}[index];
                                                        return [
                                                        `🏢 ${nombre_instancia}`,    
                                                        `〽️ Avance Real: ${avanceReal}%`,
                                                        `📊 Meta Ideal: ${ideal}%`
                                                        ];
                                                    }
                                                }
                                            },
                                            annotation: {
                                                annotations: {
                                                    line1: {
                                                        type: 'line',
                                                        mode: 'vertical',
                                                        scaleID: 'x',
                                                        value: 27, // Posición en el eje X (18%)
                                                        borderColor: 'rgba(24, 85, 216, 0.4)',
                                                        borderWidth: 2,
                                                        borderDash: [6, 6],
                                                        label: {
                                                            content: '27%',
                                                            enabled: true,
                                                            position: 'top',
                                                            backgroundColor: 'rgba(34, 25, 167, 0.7)',
                                                            color: 'white',
                                                            font: {
                                                                size: 12,
                                                                weight: 'bold'
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        },
                                        scales: {
                                            x: {
                                                beginAtZero: true,
                                                max: 100,
                                                ticks: {
                                                    callback: (value) => `${value}%`
                                                }
                                            },
                                            y: {
                                                barThickness: 0.5, // Define un tamaño fijo para todas las barras
                                                categoryPercentage: 0.5, // Ajusta el espacio entre barras
                                                barPercentage: 1.0 // Asegura que las barras ocupen el espacio definido
                                            }
                                        }
                                    },
                                    plugins: [ChartDataLabels] // Agregar el plugin
                                });
                            });
                            </script>
                        {% endfor %}
                        </div>
                    </div>
                    

                    {% comment "" %} =======================================
                    ======= CUERPO 02: AVANCE DE META ORG. JURISD. =========
                    ======================================= {% endcomment %}
                    <div class="tab-pane fade" id="navs-justified-profile" role="tabpanel">
                        <div class="col-lg-12 col-12">
                            <div class="row">
                                {% for org_jurisd, resumenes in agrupados.items %}
                                <div class="col-12">
                                        <div class="card-header pb-0 mb-0">
                                            <h4 class="font-weight-bold">{{ org_jurisd }}</h4>
                                            
                                        </div>

                                        <div class="card-body">
                                            <div class="row">
                                                {% for resumen in resumenes %}
                                                    <div class="col-lg-6 col-12">
                                                        <div class="card mb-4">
                                                            <div class="card-header mt-0 pb-1">
                                                                <h5 class="card-tittle font-weight-bolc mb-1">{{ resumen.n_instancia__x_nom_instancia }}</h5>
                                                            </div>

                                                            <div class="card-body ">
                                                                <div class="row">
                                                                    <div class="col-lg-5">
                                                                        <ul class="p-0 m-0">
                                                                            <li class="d-flex gap-4 align-items-center  pb-1">
                                                                                <div class="badge rounded bg-label-dark p-1_5"><i class="ti ti-target-arrow ti-md"></i></div>
                                                                                <div>
                                                                                    <h6 class="mb-0 text-nowrap">Meta Preliminar</h6>
                                                                                    <h6 class="text-dark mb-1">{{ resumen.m_meta_preliminar }}</h6>
                                                                                </div>
                                                                            </li>
                                                                            <li class="d-flex gap-4 align-items-center pb-1">
                                                                                <div class="badge rounded bg-label-dark p-1_5"><i class="ti ti-file-check ti-md"></i></div>
                                                                                <div>
                                                                                    <h6 class="mb-0 text-nowrap">Expedientes Resueltos</h6>
                                                                                    <h6 class="text-dark mb-1">{{ resumen.total_resuelto }}</h6>
                                                                                </div>
                                                                            </li>
                                                                            <li class="d-flex gap-4 align-items-center pb-1">
                                                                                <div class="badge rounded bg-label-dark p-1_5"><i class="ti ti-file ti-md"></i></div>
                                                                                <div>
                                                                                    <h6 class="mb-0 text-nowrap">Expedientes Ingresados</h6>
                                                                                    <h6 class="text-dark mb-1">{{ resumen.total_ingreso }}</h6>
                                                                                </div>
                                                                            </li>

                                                                            <li class="d-flex gap-4 align-items-center pb-1">
                                                                                <div class="badge rounded bg-label-dark p-1_5"><i class="ti ti-books ti-md"></i></div>
                                                                                <div>
                                                                                    <h6 class="mb-0 text-nowrap">Carga Inicial</h6>
                                                                                    <h6 class="text-dark mb-1">{{ resumen.n_carg_procesal_ini }}</h6>
                                                                                </div>
                                                                            </li>

                                                                            <li class="d-flex gap-4 align-items-center pb-1">
                                                                                <div class="badge rounded bg-label-dark p-1_5"><i class="ti ti-books ti-md"></i></div>
                                                                                <div>
                                                                                    <h6 class="mb-0 text-nowrap">Carga Procesal</h6>
                                                                                    {% if resumen.x_situacion_carga == "SUBCARGA" %}
                                                                                    <span class="badge rounded-pill bg-success">{{ resumen.x_situacion_carga }}</span>
                                                                                    {% elif resumen.x_situacion_carga == "ESTANDAR" %}
                                                                                    <span class="badge rounded-pill bg-warning">{{ resumen.x_situacion_carga }}</span>
                                                                                    {% else %}
                                                                                    <span class="badge rounded-pill bg-danger">{{ resumen.x_situacion_carga }}</span>
                                                                                    {% endif %}
                                                                                    
                                                                                </div>
                                                                            </li>              
                                                                        </ul>
                                                                    </div>

                                                                    <div class="col-lg-7 d-flex justify-content-center text-center">
                                                                        
                                                                        <div class="progress-item text-center">
                                                                            <li class="d-flex gap-4 d-flex justify-content-center align-items-center">
                                                                                <div>
                                                                                    <h6 class="mb-0 text-nowrap">Nivel Produccion</h6>
                                                                                    {% if resumen.x_niv_produc == "MUY BUENO" %}
                                                                                    <span class="badge rounded-pill bg-success">{{ resumen.x_niv_produc }}</span>
                                                                                    {% elif resumen.x_niv_produc == "BUENO" %}
                                                                                    <span class="badge rounded-pill bg-warning">{{ resumen.x_niv_produc }}</span>
                                                                                    {% else %}
                                                                                    <span class="badge rounded-pill bg-danger">{{ resumen.x_niv_produc }}</span>
                                                                                    {% endif %}
                                                                                </div>
                                                                            </li>
                                                                            <canvas id="progress-{{ forloop.counter }}" 
                                                                                    class="progress-circle" 
                                                                                    width="180" 
                                                                                    height="180"
                                                                                    data-percentage="{{ resumen.m_avan_meta }}"
                                                                                    data-nivel-produc="{{ resumen.x_niv_produc }}">
                                                                            </canvas>
                                                                            <h5 class="text-center m-0 p-0">{{ resumen.m_avan_meta }}%</h5>
                                                                            <span class="text-center m-0 p-0">PORCENTAJE DE AVANCE DE META</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div class="card-footer mb-0 pb-0">
                                                                <div class="alert alert-dark text-center" role="alert">Información: De 01 de Enero 2025 hasta {{ resumen.f_fecha_mod }}</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    {% comment "" %} =======================================
                    ===== CUERPO 03: EXP INGRESADOS VS EXP RESUELTOS =======
                    ======================================= {% endcomment %}
                    <div class="tab-pane fade" id="navs-justified-messages" role="tabpanel">
                        <div class="col-lg-12 col-12">
                            {% for jurisdiccion, instancias in agrupados.items %}
                            <h3 class="text-center font-weight-bold">{{ jurisdiccion }}</h3>
                            <canvas id="graficaHorizontal_{{ forloop.counter0 }}"></canvas>
                            <script id="data_{{ forloop.counter0 }}" type="application/json">
                                {{ instancias|safe }}
                            </script>
                            <script>
                                document.addEventListener("DOMContentLoaded", function () {
                                    const nombresInstancias_{{ forloop.counter0 }} = {{ instancias|safe }};
                                    const datosIngresos_{{ forloop.counter0 }} = nombresInstancias_{{ forloop.counter0 }}.map(i => parseFloat(i.total_ingreso));
                                    const datosResueltos_{{ forloop.counter0 }} = nombresInstancias_{{ forloop.counter0 }}.map(i => parseFloat(i.total_resuelto));
                                    const labels_{{ forloop.counter0 }} = nombresInstancias_{{ forloop.counter0 }}.map(i => i.n_instancia__x_nom_instancia);
                        
                                    const ctx_{{ forloop.counter0 }} = document.getElementById('graficaHorizontal_{{ forloop.counter0 }}').getContext('2d');
                        
                                    const myChart_{{ forloop.counter0 }} = new Chart(ctx_{{ forloop.counter0 }}, {
                                        type: 'bar',
                                        data: {
                                            labels: labels_{{ forloop.counter0 }},
                                            datasets: [
                                                {
                                                    label: 'Expedientes Ingresos a Trámite',
                                                    data: datosIngresos_{{ forloop.counter0 }},
                                                    backgroundColor: 'rgba(250,127,94,0.3)',
                                                    borderColor: 'rgba(250,127,94,0.8)',
                                                    borderWidth: 1,
                                                },
                                                {
                                                    label: 'Expedientes Resueltos',
                                                    data: datosResueltos_{{ forloop.counter0 }},
                                                    backgroundColor: '#74e9f8',
                                                    borderColor: 'rgba(78,222,241,0.8)',
                                                    borderWidth: 1,
                                                },
                                            ],
                                        },
                                        options: {
                                            indexAxis: 'y', // Barras horizontales
                                            responsive: true,
                                            plugins: {
                                                legend: {
                                                    position: 'top',
                                                },
                                                datalabels: {
                                                    anchor: 'center',
                                                    align: 'center',
                                                    formatter: (value) => value,
                                                    color: 'dark',
                                                    font: {
                                                        size: 12,
                                                        weight: 'bold',
                                                    },
                                                },
                                            },
                                            scales: {
                                                x: {
                                                    beginAtZero: true,
                                                },
                                                y: {
                                                    ticks: {
                                                        autoSkip: false, // Muestra todas las etiquetas
                                                    },
                                                    categoryPercentage: 0.5, // Reduce el espacio asignado a cada categoría
                                                    barPercentage: 0.3, // Hace las barras más delgadas dentro de la categoría
                                                    maxBarThickness: 10, // Establece un tamaño máximo para las barras (ajústalo según necesidad)
                                                }
                                            },
                                            onClick: (e, activeElements) => {
                                                if (activeElements.length > 0) {
                                                    const index = activeElements[0].index;
                                                    const instancia = myChart_{{ forloop.counter0 }}.data.labels[index];
                                                    const ingresos = myChart_{{ forloop.counter0 }}.data.datasets[0].data[index];
                                                    const resueltos = myChart_{{ forloop.counter0 }}.data.datasets[1].data[index];
                        
                                                    // Muestra el modal con los datos
                                                    document.getElementById('detalleInstancia').innerHTML = `
                                                        <div class="row">
                                                            <div class="col-lg-12 col-12">
                                                                <h3 class="text-center font-weight-bold">${instancia}</h3>
                                                            </div>
                                                            <div class="col-lg-6 col-12">
                                                                <div class="card card-dark card-outline d-flex align-items-center justify-content-center text-center">
                                                                    <div class="card-body position-relative">
                                                                        <h1>${ingresos}</h1>
                                                                        <h5 class="font-weight-bold text-center">EXPEDIENTES INGRESADOS EN TRÁMITE</h5>
                                                                    </div>
                                                                </div>
                                                            </div>
                        
                                                            <div class="col-lg-6 col-12">
                                                                <div class="card card-dark card-outline d-flex align-items-center justify-content-center text-center">
                                                                    <div class="card-body position-relative">
                                                                        <h1>${resueltos}</h1>
                                                                        <h5 class="font-weight-bold text-center">EXPEDIENTES RESUELTOS EN TRÁMITE</h5>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `;
                        
                                                    const modal = new bootstrap.Modal(document.getElementById('modalInstancia'));
                                                    modal.show();
                                                }
                                            },
                                        },
                                        plugins: [ChartDataLabels],
                                    });
                                });
                            </script>
                        {% endfor %}
                        
                            </div>
                    </div>
                </div>
                </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    function mostrarDiaAnterior() {
        const ahora = new Date();  // Obtener la fecha actual
        const diaAnterior = new Date(ahora);  // Copiar la fecha actual
        diaAnterior.setDate(ahora.getDate() - 1);  // Restar un día

        // Formatear la fecha en español
        const fechaFormateada = diaAnterior.toLocaleDateString("es-ES", {

            year: "numeric",
            month: "long",    // Mes en texto
            day: "numeric",
        });

        // Mostrar la fecha en el elemento con id 'fecha_anterior'
        document.getElementById('fecha_anterior').textContent = fechaFormateada;
    }

    // Llamar a la función cuando la página cargue
    window.onload = mostrarDiaAnterior;


    /** =============================================================
    ======================= GRÁFICO CIRCULAR ========================
    ============================================================== */
    document.addEventListener("DOMContentLoaded", function () {
        const canvases = document.querySelectorAll(".progress-circle");
    
        canvases.forEach((canvas) => {
            const ctx = canvas.getContext("2d");
            const percentage = parseFloat(canvas.getAttribute("data-percentage")); // Ahora sí obtiene el porcentaje
            const x_nivel_produc = canvas.getAttribute("data-nivel-produc"); // Obtiene el nivel de producción
    
            if (isNaN(percentage)) return; // Si no es un número, no dibujar
    
            const radius = canvas.width / 2;
            const lineWidth = 15;
            const center = radius;
    
            ctx.lineWidth = lineWidth;
    
            // Dibuja el fondo del círculo
            ctx.beginPath();
            ctx.arc(center, center, radius - lineWidth, 0, 2 * Math.PI);
            ctx.strokeStyle = "#e6e6e6";
            ctx.stroke();
    
            // Determina el color del progreso
            let progressColor;
            switch (x_nivel_produc) {
                case "MUY BUENO":
                    progressColor = "#28a745"; // Verde
                    break;
                case "BUENO":
                    progressColor = "#ffc107"; // Amarillo
                    break;
                case "BAJO":
                    progressColor = "#f44336"; // Rojo
                    break;
                default:
                    progressColor = "#6c757d"; // Gris
            }
    
            // Dibuja el progreso
            const startAngle = -Math.PI / 2;
            const endAngle = startAngle + (percentage / 100) * 2 * Math.PI;
    
            ctx.beginPath();
            ctx.arc(center, center, radius - lineWidth, startAngle, endAngle);
            ctx.strokeStyle = progressColor;
            ctx.lineCap = "round";
            ctx.stroke();
        });
    });
    

    

</script>

{% endblock %}