{% extends "base/base.html" %}
{% load static %}

{% comment %} TITULO DE PÁGINA {% endcomment %}
{% block title %} Nuevo Usuario {% endblock %}
{% block title_nav %} Nuevo Usuario {% endblock %}

{% block select_css %}
<link rel="stylesheet" href="{% static 'base/vendor/bootstrap-select/bootstrap-select.css' %}" />
<link rel="stylesheet" href="{% static 'base/vendor/select2/select2.css' %}" />
<link rel="stylesheet" href="{% static 'base/vendor/form-validation/form-validation.css' %}" />
{% endblock  %}

{% block stepper_css %}
<link rel="stylesheet" href="{% static 'base/vendor/stepper/stepper.css' %}" />
{% endblock  %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'base/vendor/fonts/tabler-icons.css' %}" />
<link rel="stylesheet" href="{% static 'base/vendor/fonts/flag-icons.css' %}" />
<link rel="stylesheet" href="{% static 'base/css/cards-advance.css' %}" />
{% endblock  %}

{% block datatable_css %}
<link rel="stylesheet" href="{% static 'base/vendor/datatables/dt/datatables.bootstrap5.css' %}" />
<link rel="stylesheet" href="{% static 'base/vendor/datatables/responsive/responsive.bootstrap5.css' %}" />
<link rel="stylesheet" href="{% static 'base/vendor/datatables/checkboxes/datatables.checkboxes.css' %} "/>
{% endblock  %}

{% comment %} CUERPO DEL CONTENIDO {% endcomment %}
{% block body_container %}
<div class="container-xxl flex-grow-1 container-p-y">
    <div class="row">
        <div class="col-12">
            <div class="row mt-2">
                <div class="col-md-4 col-xxl-4 mb-6">
                    <div class="card h-100">
                      <div class="card-body">

                        {% if obj %}
                        <div class=" rounded text-center mb-2 pt-4">
                          <img class="img-fluid" src="{% static "base/img/images/editar.jpg" %}" alt="Editar" width="250" />
                        </div>
                        <h3 class="font-weight-bold mb-2 text-center">Editar Usuario</h3>
                        {% else %}
                        <div class=" rounded text-center mb-2 pt-4">
                          <img class="img-fluid" src="{% static "base/img/inicio.jpg" %}" alt="Usuario Nuevo" width="250" />
                        </div>
                        <h3 class="font-weight-bold mb-2 text-center">Agregar Usuario</h3>
                        {% endif %}
                        <p>
                          Ingrese la información del nuevo usuario.
                        </p>
                        <a href="{% url "bases:user_list" %}" class="btn rounded-pill btn-dark text-center">Regresar Listar Usuarios</a>
                      </div>
                    </div>
                </div>

                <div class="col-8 mb-6">
                  
                  <div class="bs-stepper wizard-numbered mt-2">
                    
                    <div class="bs-stepper-header">
                      <div class="step" data-target="#account-details">
                        <button type="button" class="step-trigger">
                          <span class="bs-stepper-circle">1</span>
                          <span class="bs-stepper-label">
                            <span class="bs-stepper-title">Información Personal</span>
                            <span class="bs-stepper-subtitle">Agregar Información</span>
                          </span>
                        </button>
                      </div>

                      <div class="line">
                        <i class="ti ti-chevron-right"></i>
                      </div>

                      <div class="step" data-target="#personal-info">
                        <button type="button" class="step-trigger">
                          <span class="bs-stepper-circle">2</span>
                          <span class="bs-stepper-label">
                            <span class="bs-stepper-title">Credenciales Usuario</span>
                            <span class="bs-stepper-subtitle">Usuario y Password</span>
                          </span>
                        </button>
                      </div>
                    </div>

                    <div class="bs-stepper-content">
                      <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <!-- Account Details -->
                        <div id="account-details" class="content">    
                          <div class="row g-6">
                            <div class="col-sm-6">
                              <label class="form-label" for="username">Apellido Paterno:</label>
                              <div class="input-group input-group-merge">
                                <span id="basic-icon-default-fullname2" class="input-group-text"
                                  ><i class="fa-regular fa-user"></i></i
                                ></span>
                                {{form.x_app_paterno}}
                              </div>
                            </div>

                            <div class="col-sm-6">
                              <label class="form-label" for="username">Apellido Materno:</label>
                              <div class="input-group input-group-merge">
                                <span id="basic-icon-default-fullname2" class="input-group-text"
                                  ><i class="fa-regular fa-user"></i></i
                                ></span>
                                {{form.x_app_materno}}
                              </div>
                            </div>

                            <div class="col-sm-6">
                              <label class="form-label" for="username">Nombres:</label>
                              <div class="input-group input-group-merge">
                                <span id="basic-icon-default-fullname2" class="input-group-text"
                                  ><i class="fa-regular fa-user"></i></i
                                ></span>
                                {{form.x_nombres}}
                              </div>
                            </div>

                            <div class="col-sm-6">
                              <label class="form-label" for="username">DNI:</label>
                              <div class="input-group input-group-merge">
                                <span id="basic-icon-default-fullname2" class="input-group-text"><i class="fa-regular fa-address-card"></i></span>
                                {{form.x_dni}}
                              </div>
                            </div>
                            
                            <div class="col-sm-6">
                              <label class="form-label" for="email">Sexo</label>
                                {{form.n_id_sexo}}
                            </div>

                            <div class="col-sm-6 form-password-toggle">
                              <label class="form-label" for="password">Correo Electronico</label>
                              <div class="input-group input-group-merge">
                                <div class="input-group input-group-merge">
                                  <span class="input-group-text"><i class="ti ti-mail"></i></span>
                                  {{form.email}}
                                  <span id="basic-icon-default-email2" class="input-group-text">@example.com</span>
                                </div>
                                <div class="form-text">Puedes ingresar números y letras</div>
                              </div>
                            </div>

                            <div class="col-sm-12 form-password-toggle mt-2">
                              <label class="form-label" for="profile_image">Imagen de Perfil:</label>
                              <div class="input-group input-group-merge">
                                  <span id="basic-icon-default-profile" class="input-group-text">
                                      <i class="fa-regular fa-image"></i>
                                  </span>
                                  {{ form.profile_image }}
                              </div>
                            </div>

                            <div class="col-12 d-flex justify-content-between">
                              <button class="btn btn-label-secondary btn-prev" disabled>
                                <i class="ti ti-arrow-left ti-xs me-sm-2 me-0"></i>
                                <span class="align-middle d-sm-inline-block d-none">Previous</span>
                              </button>
                              
                              <button type="button" class="btn btn-primary btn-next">
                                <span class="align-middle d-sm-inline-block d-none me-sm-2">Next</span>
                                <i class="ti ti-arrow-right ti-xs"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Personal Info -->
                        <div id="personal-info" class="content">
                          <div class="row g-6">

                            <div class="col-sm-6">
      <label class="form-label">Teléfono:</label>
      <div class="input-group input-group-merge">
        <span class="input-group-text"><i class="ti ti-phone"></i></span>
        {{ form.x_telefono }}
      </div>
      <div class="form-text">Ejemplo: 999888777 o +51 999888777</div>
    </div>

    <div class="col-sm-6">
      <label class="form-label d-block">Mensajes / Notificaciones:</label>
      <div class="form-check form-switch">
        {{ form.l_mensaje }}
        <label class="form-check-label ms-2">Habilitar mensajes (WhatsApp/SMS/Email)</label>
      </div>
    </div>

                            <div class="col-sm-6">
                              <label class="form-label" for="first-name">Usuario:</label>
                              <div class="input-group input-group-merge">
                                <span id="basic-icon-default-fullname2" class="input-group-text"
                                  ><i class="ti ti-user"></i
                                ></span>
                                {{form.username}}
                              </div>
                            </div>
                            {% if not obj %}
                            <div class="col-sm-6">
                              <label class="form-label" for="last-name">Contraseña:</label>
                              <div class="input-group input-group-merge">
                                <span id="basic-icon-default-fullname2" class="input-group-text"
                                  ><i class="ti ti-user"></i
                                ></span>
                                {{form.password}}
                              </div>
                            </div>
                            {% endif %}

                            <div class="col-12 d-flex justify-content-between">
                              <button type="button" class="btn btn-label-secondary btn-prev">
                                <i class="ti ti-arrow-left ti-xs me-sm-2 me-0"></i>
                                <span class="align-middle d-sm-inline-block d-none">Previous</span>
                              </button>
                              <button type="submit" class="btn btn-success">Enviar</button>
                            </div>
                          </div>
                        </div>

                      </form>
                    </div>
                  </div>
                </div>
            </div>
        </div>

        {% if obj %}
        <div class="col-12">
          <div class="row">
              <div class="col-xl-6 col-12">
                  <div class="card">
                      <div class="card-header mb-0 pb-0">
                        <h4 class="card-tittle font-weight-bold">GRUPOS ASIGNADOS</h4>
                      </div>
    
                      <div class="card-body">
                          <table class="table table-bordered">
                              <thead>
                                  <tr>
                                      <th>ID</th>
                                      <th>NOMBRE</th>
                                      <th>ACCIONES</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  {% for item in grupos_usuario %}
                                  <tr>
                                      <td>{{forloop.counter}}</td>
                                      <td>{{item.name}}</td>
                                      <td>
                                          <a href="" class="btn btn-sm btn-cirlce btn-danger" onclick="permiso('{{item.id}}','DEL')">
                                              <svg xmlns="http://www.w3.org/2000/svg" width="15" viewBox="0 0 448 512"><path fill="currentColor" d="M135.2 17.7C140.6 6.8 151.7 0 163.8 0L284.2 0c12.1 0 23.2 6.8 28.6 17.7L320 32l96 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L32 96C14.3 96 0 81.7 0 64S14.3 32 32 32l96 0 7.2-14.3zM32 128l384 0 0 320c0 35.3-28.7 64-64 64L96 512c-35.3 0-64-28.7-64-64l0-320zm96 64c-8.8 0-16 7.2-16 16l0 224c0 8.8 7.2 16 16 16s16-7.2 16-16l0-224c0-8.8-7.2-16-16-16zm96 0c-8.8 0-16 7.2-16 16l0 224c0 8.8 7.2 16 16 16s16-7.2 16-16l0-224c0-8.8-7.2-16-16-16zm96 0c-8.8 0-16 7.2-16 16l0 224c0 8.8 7.2 16 16 16s16-7.2 16-16l0-224c0-8.8-7.2-16-16-16z"/></svg>
                                          </a>
                                      </td>
                                  </tr>
                                  {% endfor %}
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>

              <div class="col-xl-6 col-12">
                  <div class="card">
                      <div class="card-header pb-0 mb-0">
                        <h4 class="card-tittle pb-0 mb-0 font-weight-bold">GRUPOS DISPONIBLES</h4>
                      </div>

                      <div class="card-body">
                          <table class="table table-bordered">
                              <thead>
                                  <tr>
                                      <th>ID</th>
                                      <th>NOMBRE</th>
                                      <th>ACCIONES</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  {% for item in grupos %}
                                  <tr>
                                      <td>{{item.id}}</td>
                                      <td class="text-uppercase">{{item.name}}</td>
                                      <td>
                                          <a href="#" type="button" class="btn btn-sm btn-success btn-circle" onclick="permiso('{{item.id}}','ADD')">
                                              <svg xmlns="http://www.w3.org/2000/svg" width="15" viewBox="0 0 448 512"><path fill="currentColor" d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 144L48 224c-17.7 0-32 14.3-32 32s14.3 32 32 32l144 0 0 144c0 17.7 14.3 32 32 32s32-14.3 32-32l0-144 144 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-144 0 0-144z"/></svg>
                                          </a>
                                      </td>
                                  </tr>
                                  {% endfor %}
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
          </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% comment %} SCRIPT {% endcomment %}
{% block script %}
<script>
    $(document).ready(function(){
      $('.table').DataTable();
    });

    function permiso(id,accion){
        var url = "/grupos/usuarios/{{obj.id}}/"+id
        var token = '{{csrf_token}}'
        var data = {"accion":accion}

        console.log(url,token,data);
        $.ajax({
            headers: { "X-CSRFToken": token },
            type: "POST",
            url: url,
            data: data,
            success: function(response) {
                if (response.status === "success") {
                    Swal.fire({
                        position: 'top-center',
                        icon: 'success',
                        title: response.title,
                        showConfirmButton: false,
                        timer: 1500
                    }).then(() => {
                        location.reload(true);
                    });
                } else {
                    Swal.fire({
                        position: 'top-center',
                        icon: 'error',
                        title: response.title,
                        showConfirmButton: false,
                        timer: 1500
                    });
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log(textStatus, errorThrown);
                Swal.fire({
                    position: 'top-center',
                    icon: 'error',
                    title: 'Error',
                    showConfirmButton: false,
                    timer: 1500
                });
            }
        });
    }

    $(document).ready(function() {
      $('#id_n_id_sexo').select2();  // Reemplaza con el ID del campo generado
  });
</script>
{% endblock %}

{% block form_js %}
<script src="{% static 'base/vendor/bootstrap-select/bootstrap-select.js' %}"></script>
<script src="{% static 'base/vendor/select2/select2.js' %}"></script>
<script src="{% static 'base/vendor/form-validation/popular.js' %}"></script>
<script src="{% static 'base/vendor/form-validation/bootstrap5.js' %}"></script>
<script src="{% static 'base/vendor/form-validation/auto-focus.js' %}"></script>
{% endblock %}

{% block stepper_js %}
<script src="{% static 'base/vendor/stepper/stepper.js' %}"></script>
<script src="{% static 'base/vendor/stepper/form-wizard-numbered.js' %}"></script>
{% endblock %}

{% block datatable_js %}
<script src="{% static 'base/vendor/datatables5/datatables-bootstrap5.js' %}"></script>
{% endblock %}