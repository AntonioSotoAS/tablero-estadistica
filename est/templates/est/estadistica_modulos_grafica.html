{% extends "base/base.html" %}
{% load static %}

{% block title %}Módulos :: Estadistica{% endblock  %}
{% block title_nav %}{% endblock  %}

{% block grafico_css %}
<link rel="stylesheet" href="{% static 'base/vendor/apex-charts/apex-charts.css' %}" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock  %}

{% block body_container %}
    <style>
        /* Contenedor del gráfico */
        #chart-container {
            width: 100%;
            height: 60vh; /* Usa una altura relativa a la ventana para adaptarlo */
            max-height: 600px; /* Máximo para pantallas grandes */
        }
    </style>

    <section class="content">
        <div class="container-xxl flex-grow-1 container-p-y pt-5">
            {% if perms.est.list_mae_est_modulos or perms.est.list_mov_est_modulo_usuarios %}
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="nav-align-top nav-tabs-shadow mb-6">
                            {% comment "" %} =======================================
                            =============== CABECERAS DEL PANEL ====================
                            ======================================= {% endcomment %}
                            <ul class="nav nav-tabs nav-fill" role="tablist">
                                {% comment "" %} =======================================
                                ================== GRAFICO GENERAL =====================
                                ======================================= {% endcomment %}
                                <li class="nav-item">
                                    <button type="button" class="nav-link active" role="tab" data-bs-toggle="tab" data-bs-target="#navs-justified-home" aria-controls="navs-justified-home" aria-selected="true">
                                        <span class="d-none d-sm-inline-flex align-items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" class="icon-base icon-sm me-1_5" viewBox="0 0 640 640"><path fill="currentColor" d="M96 96C113.7 96 128 110.3 128 128L128 464C128 472.8 135.2 480 144 480L544 480C561.7 480 576 494.3 576 512C576 529.7 561.7 544 544 544L144 544C99.8 544 64 508.2 64 464L64 128C64 110.3 78.3 96 96 96zM208 288C225.7 288 240 302.3 240 320L240 384C240 401.7 225.7 416 208 416C190.3 416 176 401.7 176 384L176 320C176 302.3 190.3 288 208 288zM352 224L352 384C352 401.7 337.7 416 320 416C302.3 416 288 401.7 288 384L288 224C288 206.3 302.3 192 320 192C337.7 192 352 206.3 352 224zM432 256C449.7 256 464 270.3 464 288L464 384C464 401.7 449.7 416 432 416C414.3 416 400 401.7 400 384L400 288C400 270.3 414.3 256 432 256zM576 160L576 384C576 401.7 561.7 416 544 416C526.3 416 512 401.7 512 384L512 160C512 142.3 526.3 128 544 128C561.7 128 576 142.3 576 160z"/></svg>
                                            Grafico General</span>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" class="icon-base icon-sm d-sm-none" viewBox="0 0 640 640"><path fill="currentColor" d="M96 96C113.7 96 128 110.3 128 128L128 464C128 472.8 135.2 480 144 480L544 480C561.7 480 576 494.3 576 512C576 529.7 561.7 544 544 544L144 544C99.8 544 64 508.2 64 464L64 128C64 110.3 78.3 96 96 96zM208 288C225.7 288 240 302.3 240 320L240 384C240 401.7 225.7 416 208 416C190.3 416 176 401.7 176 384L176 320C176 302.3 190.3 288 208 288zM352 224L352 384C352 401.7 337.7 416 320 416C302.3 416 288 401.7 288 384L288 224C288 206.3 302.3 192 320 192C337.7 192 352 206.3 352 224zM432 256C449.7 256 464 270.3 464 288L464 384C464 401.7 449.7 416 432 416C414.3 416 400 401.7 400 384L400 288C400 270.3 414.3 256 432 256zM576 160L576 384C576 401.7 561.7 416 544 416C526.3 416 512 401.7 512 384L512 160C512 142.3 526.3 128 544 128C561.7 128 576 142.3 576 160z"/></svg>
                                        
                                    </button>
                                </li>

                                {% comment "" %} =======================================
                                =========== AVANCE DE META POR ORG. JURISD. ============
                                ======================================= {% endcomment %}
                                <li class="nav-item">
                                    <button type="button" class="nav-link" role="tab" data-bs-toggle="tab" data-bs-target="#navs-justified-profile" aria-controls="navs-justified-profile" aria-selected="false">
                                        <span class="d-none d-sm-inline-flex align-items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" class="icon-base icon-sm me-1_5" viewBox="0 0 640 640"><path fill="currentColor" d="M128 64C145.7 64 160 78.3 160 96L160 112L229 94.8C267.1 85.3 307.3 89.7 342.5 107.3C388.8 130.5 443.3 130.5 489.6 107.3L499.2 102.5C519.8 92.1 544 107.1 544 130.1L544 409.8C544 423.1 535.7 435.1 523.2 439.8L488.5 452.8C442.3 470.1 390.9 467.4 346.8 445.4C308.9 426.4 265.4 421.7 224.3 432L160 448L160 544C160 561.7 145.7 576 128 576C110.3 576 96 561.7 96 544L96 96C96 78.3 110.3 64 128 64zM160 251.1L224 237.2L224 302.7L160 316.6L160 382.1L208.8 369.9C213.9 368.6 218.9 367.5 224 366.6L224 302.7L262.9 294.3C271.2 292.5 279.6 291.8 288 292.2L288 228.2C301.6 228.6 315.2 230.8 328.4 234.6L352 241.5L352 308.2L310.3 295.9C303 293.8 295.5 292.5 288 292.1L288 363.5C309.8 365.4 331.3 370.2 352 377.9L352 308.1L374.7 314.8C388.2 318.8 402 321.2 416 322.2L416 258C408.2 257.2 400.4 255.7 392.8 253.5L352 241.5L352 179.5C339 175.7 326.2 170.7 313.8 164.5C305.6 160.4 296.9 157.5 288 155.7L288 228.1C275 227.7 262 228.9 249.3 231.7L224 237.2L224 162L160 178L160 251.1zM416 399.7C432.8 401.2 449.9 399 466 392.9L480 387.7L480 316L472.1 317.8C453.7 322.1 434.8 323.5 416 322.3L416 399.7zM480 250.3L480 179.5C459.1 185.6 437.6 188.6 416 188.6L416 258C429.9 259.4 444 258.5 457.7 255.4L480 250.2z"/></svg>
                                            Avance de Meta por Org. Jurisdiccional</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" class="icon-base icon-sm d-sm-none" viewBox="0 0 640 640"><path fill="currentColor" d="M128 64C145.7 64 160 78.3 160 96L160 112L229 94.8C267.1 85.3 307.3 89.7 342.5 107.3C388.8 130.5 443.3 130.5 489.6 107.3L499.2 102.5C519.8 92.1 544 107.1 544 130.1L544 409.8C544 423.1 535.7 435.1 523.2 439.8L488.5 452.8C442.3 470.1 390.9 467.4 346.8 445.4C308.9 426.4 265.4 421.7 224.3 432L160 448L160 544C160 561.7 145.7 576 128 576C110.3 576 96 561.7 96 544L96 96C96 78.3 110.3 64 128 64zM160 251.1L224 237.2L224 302.7L160 316.6L160 382.1L208.8 369.9C213.9 368.6 218.9 367.5 224 366.6L224 302.7L262.9 294.3C271.2 292.5 279.6 291.8 288 292.2L288 228.2C301.6 228.6 315.2 230.8 328.4 234.6L352 241.5L352 308.2L310.3 295.9C303 293.8 295.5 292.5 288 292.1L288 363.5C309.8 365.4 331.3 370.2 352 377.9L352 308.1L374.7 314.8C388.2 318.8 402 321.2 416 322.2L416 258C408.2 257.2 400.4 255.7 392.8 253.5L352 241.5L352 179.5C339 175.7 326.2 170.7 313.8 164.5C305.6 160.4 296.9 157.5 288 155.7L288 228.1C275 227.7 262 228.9 249.3 231.7L224 237.2L224 162L160 178L160 251.1zM416 399.7C432.8 401.2 449.9 399 466 392.9L480 387.7L480 316L472.1 317.8C453.7 322.1 434.8 323.5 416 322.3L416 399.7zM480 250.3L480 179.5C459.1 185.6 437.6 188.6 416 188.6L416 258C429.9 259.4 444 258.5 457.7 255.4L480 250.2z"/></svg>
                                    </button>

                                    
                                </li>

                                {% comment "" %} =======================================
                                ======== EXPEDIENTE INGRESADOS VS RESUELTOS ============
                                ======================================= {% endcomment %}
                                <li class="nav-item">
                                    <button type="button" class="nav-link" role="tab" data-bs-toggle="tab" data-bs-target="#navs-justified-messages" aria-controls="navs-justified-messages" aria-selected="false">
                                        <span class="d-none d-sm-inline-flex align-items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" class="icon-base icon-sm me-1_5" viewBox="0 0 640 640"><path fill="currentColor" d="M96 128C96 92.7 124.7 64 160 64C195.3 64 224 92.7 224 128C224 163.3 195.3 192 160 192C124.7 192 96 163.3 96 128zM64 288C64 252.7 92.7 224 128 224L192 224C195.2 224 198.4 224.2 201.5 224.7L157.1 269.1C129 297.2 129 342.8 157.1 370.9L213.1 426.9C216.5 430.3 220.1 433.3 224 435.9L224 528C224 554.5 202.5 576 176 576L144 576C117.5 576 96 554.5 96 528L96 407.4C76.9 396.4 64 375.7 64 352L64 288zM416 128C416 92.7 444.7 64 480 64C515.3 64 544 92.7 544 128C544 163.3 515.3 192 480 192C444.7 192 416 163.3 416 128zM482.9 269.1L438.5 224.7C441.6 224.2 444.8 224 448 224L512 224C547.3 224 576 252.7 576 288L576 352C576 375.7 563.1 396.4 544 407.4L544 528C544 554.5 522.5 576 496 576L464 576C437.5 576 416 554.5 416 528L416 435.9C419.9 433.3 423.5 430.3 426.9 426.9L482.9 370.9C511 342.8 511 297.2 482.9 269.1zM366.8 241.8C375.8 238.1 386.1 240.1 393 247L449 303C458.4 312.4 458.4 327.6 449 336.9L393 392.9C386.1 399.8 375.8 401.8 366.8 398.1C357.8 394.4 352 385.7 352 376L352 352L288 352L288 376C288 385.7 282.2 394.5 273.2 398.2C264.2 401.9 253.9 399.9 247 393L191 337C181.6 327.6 181.6 312.4 191 303.1L247 247.1C253.9 240.2 264.2 238.2 273.2 241.9C282.2 245.6 288 254.3 288 264L288 288L352 288L352 264C352 254.3 357.8 245.5 366.8 241.8z"/></svg>
                                            Ingresos VS Resueltos en Trámite</span>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" class="icon-base icon-sm d-sm-none" viewBox="0 0 640 640"><path fill="currentColor" d="M96 128C96 92.7 124.7 64 160 64C195.3 64 224 92.7 224 128C224 163.3 195.3 192 160 192C124.7 192 96 163.3 96 128zM64 288C64 252.7 92.7 224 128 224L192 224C195.2 224 198.4 224.2 201.5 224.7L157.1 269.1C129 297.2 129 342.8 157.1 370.9L213.1 426.9C216.5 430.3 220.1 433.3 224 435.9L224 528C224 554.5 202.5 576 176 576L144 576C117.5 576 96 554.5 96 528L96 407.4C76.9 396.4 64 375.7 64 352L64 288zM416 128C416 92.7 444.7 64 480 64C515.3 64 544 92.7 544 128C544 163.3 515.3 192 480 192C444.7 192 416 163.3 416 128zM482.9 269.1L438.5 224.7C441.6 224.2 444.8 224 448 224L512 224C547.3 224 576 252.7 576 288L576 352C576 375.7 563.1 396.4 544 407.4L544 528C544 554.5 522.5 576 496 576L464 576C437.5 576 416 554.5 416 528L416 435.9C419.9 433.3 423.5 430.3 426.9 426.9L482.9 370.9C511 342.8 511 297.2 482.9 269.1zM366.8 241.8C375.8 238.1 386.1 240.1 393 247L449 303C458.4 312.4 458.4 327.6 449 336.9L393 392.9C386.1 399.8 375.8 401.8 366.8 398.1C357.8 394.4 352 385.7 352 376L352 352L288 352L288 376C288 385.7 282.2 394.5 273.2 398.2C264.2 401.9 253.9 399.9 247 393L191 337C181.6 327.6 181.6 312.4 191 303.1L247 247.1C253.9 240.2 264.2 238.2 273.2 241.9C282.2 245.6 288 254.3 288 264L288 288L352 288L352 264C352 254.3 357.8 245.5 366.8 241.8z"/></svg>
                                        
                                    </button>
                                </li>
                            </ul>

                            {% comment "" %} =======================================
                            ================= CUERPO DEL PANEL =====================
                            ======================================= {% endcomment %}
                            <div class="tab-content pt-2">
                                {% comment "" %} =======================================
                                ======= CUERPO 01: GRAFICO POR PORCENTAJE ==============
                                ======================================= {% endcomment %}
                                <div class="tab-pane fade show active" id="navs-justified-home" role="tabpanel">
                                    <div class="col-lg-12 col-12">
                                        {% for jurisdiccion, grupo in agrupados.items %}
                                            <h3 class="text-center mt-5 mb-0 fw-bold">RANKING DE {{ jurisdiccion }}</h3>
                                            <div class="text-center mt-0 mb-3">
                                                <span class="fw-bold">Información:</span> Desde 01 de enero hasta 
                                                <span class="fw-bold">{{ fecha_modificacion }}</span>
                                            </div>

                                            <div class="row g-4">
                                                <div class="col-12 col-lg-12">
                                                <div class="card border-0 shadow-sm h-100">
                                                    <div class="card-body text-center">
                                                    <h4>
                                                        <span class="badge bg-info mb-3">Mes Actual</span>
                                                        <span class="badge bg-label-info">Escala Ideal: {{ meta_ideal_A }}%</span>
                                                    </h4>
                                                    <div id="graficoEcharts_A_{{ forloop.counter }}" style="height: 600px;"></div>
                                                    </div>
                                                </div>
                                                </div>
                                            </div>

                                            <script>
                                                document.addEventListener("DOMContentLoaded", function () {
                                                    // Arreglo global con todas las instancias (lo pasaste en el context como "instancias")
                                                    const todas = {{ instancias|safe }};
                                                    const META_IDEAL_A = parseFloat('{{ meta_ideal_A|default:"0" }}');

                                                    // Filtrar por órgano jurisdiccional del bloque y por estado A (mes actual)
                                                    const dataA = todas.filter(i => 
                                                    i.estado === 'A' && i.n_instancia__c_org_jurisd__x_nom_org_jurisd === "{{ jurisdiccion|escapejs }}"
                                                    );

                                                    const contA = document.getElementById('graficoEcharts_A_{{ forloop.counter }}');
                                                    const chartA = echarts.init(contA);

                                                    function buildOption(dataFiltrado, metaIdealGlobal) {
                                                    const labels = dataFiltrado.map(i => i.n_instancia__x_nom_instancia);
                                                    const nombres_juez = dataFiltrado.map(i => i.juez_nombre || 'Sin juez asignado');
                                                    const avance = dataFiltrado.map(i => parseFloat(i.m_avan_meta));
                                                    const ideal  = dataFiltrado.map(i => parseFloat(i.m_ideal_avan_meta));

                                                    const colores = avance.map((v, idx) => v < ideal[idx]
                                                        ? 'rgba(255, 99, 132, 0.7)'   // rojo
                                                        : 'rgba(75, 192, 192, 0.7)'   // verde
                                                    );

                                                    return {
                                                        tooltip: {
                                                        trigger: 'axis',
                                                        axisPointer: { type: 'shadow' },
                                                        formatter: function (params) {
                                                            const idx = params[0].dataIndex;
                                                            return `
                                                            👨‍⚖️ <b>Juez:</b> ${nombres_juez[idx]}<br/>
                                                            🏢 <b>${labels[idx]}</b><br/>
                                                            〽️ <b>Avance Real:</b> ${avance[idx]}%<br/>
                                                            📊 <b>Meta Ideal (instancia):</b> ${ideal[idx]}%
                                                            `;
                                                        }
                                                        },
                                                        grid: { left: '3%', right: 14, bottom: '6%', top: 28, containLabel: true },
                                                        xAxis: { type: 'value', max: 100, axisLabel: { formatter: '{value}%' } },
                                                        yAxis: {
                                                        type: 'category',
                                                        data: labels,
                                                        axisLabel: {
                                                            formatter: v => v.length > 28 ? v.slice(0, 28) + '…' : v,
                                                            interval: 0
                                                        }
                                                        },
                                                        series: [{
                                                        name: '% Avance',
                                                        type: 'bar',
                                                        data: avance,
                                                        itemStyle: { color: params => colores[params.dataIndex] },
                                                        label: {
                                                            show: true,
                                                            position: 'insideRight',
                                                            formatter: '{c}%',
                                                            fontWeight: 'bold',
                                                            color: 'rgb(0,0,0)'
                                                        },
                                                        // Línea vertical de meta ideal GLOBAL (escala del mes actual)
                                                        markLine: {
                                                            symbol: 'none',
                                                            lineStyle: { type: 'dashed', color: 'rgba(24, 85, 216, 0.8)' },
                                                            label: {
                                                            position: 'end',
                                                            formatter: `Meta Ideal ${metaIdealGlobal}%`,
                                                            fontWeight: 'bold',
                                                            backgroundColor: 'rgba(34, 25, 167, 0.7)',
                                                            color: '#fff',
                                                            padding: 4
                                                            },
                                                            data: [{ xAxis: metaIdealGlobal }]
                                                        }
                                                        }]
                                                    };
                                                    }

                                                    chartA.setOption(buildOption(dataA, META_IDEAL_A));

                                                    window.addEventListener('resize', () => { chartA.resize(); });
                                                });
                                            </script>

                                        {% endfor %}

                                    </div>
                                </div>
                                
                                {% comment "" %} =======================================
                                ======= CUERPO 02: AVANCE DE META ORG. JURISD. =========
                                ======================================= {% endcomment %}
                                <div class="tab-pane fade" id="navs-justified-profile" role="tabpanel">
                                    <div class="col-lg-12 col-12">
                                        <div class="row">
                                            {% for org_jurisd, resumenes in agrupados.items %}
                                            <div class="col-12 mt-3">
                                                <h4 class="text-center mb-0 font-weight-bold">{{ org_jurisd }}</h4>
                                                <div class="text-center mt-0 mb-3"><span class="font-weight-bold">Información:</span> Desde 01 de Enero hasta <span class="font-weight-bold">{{ fecha_modificacion }}</span></div>
                                            </div>
                                            {% for resumen in resumenes %}
                                                <div class="col-lg-6 col-12">
                                                    <div class="card mb-2">
                                                        <div class="card-header pb-1">
                                                            <h6 class="mb-1">{{ resumen.n_instancia__x_nom_instancia }}</h6>
                                                        </div>
                                                        <div class="card-body d-flex justify-content-center align-items-center p-4 pt-2">
                                                            <div class="row">
                                                                <div class="col-lg-6">
                                                                    <ul class="p-0 m-0">
                                                                        <li class="d-flex gap-4 align-items-center  pb-1 mt-1 pt-1">
                                                                            <div class="badge rounded bg-label-dark p-1_5"><i class="ti ti-target-arrow ti-md"></i></div>
                                                                            <div>
                                                                                <h6 class="mb-0 text-nowrap">Meta Preliminar</h6>
                                                                                <h6 class="text-dark mb-1">{{ resumen.m_meta_preliminar }}</h6>
                                                                            </div>
                                                                        </li>
                                                                        <li class="d-flex gap-4 align-items-center pb-1">
                                                                            <div class="badge rounded bg-label-dark p-1_5">
                                                                                <i class="ti ti-file-check ti-md"></i>
                                                                            </div>
                                                                            <div>
                                                                                <h6 class="mb-0 text-nowrap">Expedientes Resueltos</h6>
                                                                                <h6 class="text-dark mb-1">{{ resumen.total_resuelto }}</h6>
                                                                            </div>
                                                                        </li>
                                                                        <li class="d-flex gap-4 align-items-center pb-1">
                                                                            <div class="badge rounded bg-label-dark p-1_5"><i class="ti ti-file ti-md"></i></div>
                                                                            <div>
                                                                                <h6 class="mb-0 text-nowrap">Expedientes Ingresados</h6>
                                                                                <h6 class="text-dark mb-1">{{ resumen.total_ingreso }}</h6>
                                                                            </div>
                                                                        </li>
                                                                        <li class="d-flex gap-4 align-items-center pb-1">
                                                                            <div class="badge rounded bg-label-dark p-1_5"><i class="ti ti-books ti-md"></i></div>
                                                                            <div>
                                                                                <h6 class="mb-0 text-nowrap">Carga Inicial</h6>
                                                                                <h6 class="text-dark mb-1">{{ resumen.n_carg_procesal_ini }}</h6>
                                                                            </div>
                                                                        </li>
                                                                        <li class="d-flex gap-4 align-items-center pb-1">
                                                                            <div class="badge rounded bg-label-dark p-1_5 bg-success text-white"><i class="ti ti-golf ti-md"></i></div>
                                                                            <div>
                                                                                <h6 class="mb-0 text-nowrap">Meta Ideal</h6>
                                                                                <h6 class="text-dark mb-1">{{ resumen.m_ideal_avan_meta }}%</h6>
                                                                            </div>
                                                                        </li>
                                                                    </ul>
                                                                </div>
                                                                <div class="col-lg-6 d-flex justify-content-center text-center">
                                                                    <div class="progress-item text-center">
                                                                        <li class="d-flex gap-4 d-flex justify-content-center align-items-center">
                                                                            <div>
                                                                                <h6 class="mb-0 text-nowrap">Nivel Produccion</h6>
                                                                                {% if resumen.x_niv_produc == "MUY BUENO" %}
                                                                                <span class="badge rounded-pill bg-success">{{ resumen.x_niv_produc }}</span>
                                                                                {% elif resumen.x_niv_produc == "BUENO" %}
                                                                                <span class="badge rounded-pill bg-warning">{{ resumen.x_niv_produc }}</span>
                                                                                {% else %}
                                                                                <span class="badge rounded-pill bg-danger">{{ resumen.x_niv_produc }}</span>
                                                                                {% endif %}
                                                                            </div>
                                                                        </li>
                                                                        <canvas id="progress-{{ forloop.counter }}" 
                                                                                class="progress-circle" 
                                                                                width="180" 
                                                                                height="180"
                                                                                data-percentage="{{ resumen.m_avan_meta }}"
                                                                                data-nivel-produc="{{ resumen.x_niv_produc }}">
                                                                        </canvas>
                                                                        <h5 class="text-center m-0 p-0">{{ resumen.m_avan_meta }}%</h5>
                                                                        <span class="text-center m-0 p-0">PORCENTAJE DE AVANCE DE META</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% endfor %}
                                        </div>
                                    </div>
                                </div>

                                {% comment "" %} =======================================
                                ===== CUERPO 03: EXP INGRESADOS VS EXP RESUELTOS =======
                                ======================================= {% endcomment %}
                                <div class="tab-pane fade" id="navs-justified-messages" role="tabpanel">
                                    <div class="col-lg-12 col-12">
                                        {% for jurisdiccion, instancias in agrupados.items %}
                                        <h3 class="text-center font-weight-bold mb-0">{{ jurisdiccion }}</h3>
                                        <div class="text-center mt-0 mb-3"><span class="font-weight-bold">Información:</span> Desde 01 de Enero hasta <span class="font-weight-bold">{{ fecha_modificacion }}</span></div>
                                        <canvas id="graficaHorizontal_{{ forloop.counter0 }}"></canvas>
                                        <script id="data_{{ forloop.counter0 }}" type="application/json">
                                            {{ instancias|safe }}
                                        </script>
                                        <script>
                                            document.addEventListener("DOMContentLoaded", function () {
                                                const nombresInstancias_{{ forloop.counter0 }} = {{ instancias|safe }};
                                                const datosIngresos_{{ forloop.counter0 }} = nombresInstancias_{{ forloop.counter0 }}.map(i => parseFloat(i.total_ingreso));
                                                const datosResueltos_{{ forloop.counter0 }} = nombresInstancias_{{ forloop.counter0 }}.map(i => parseFloat(i.total_resuelto));
                                                const labels_{{ forloop.counter0 }} = nombresInstancias_{{ forloop.counter0 }}.map(i => i.n_instancia__x_nom_instancia);
                                    
                                                const ctx_{{ forloop.counter0 }} = document.getElementById('graficaHorizontal_{{ forloop.counter0 }}').getContext('2d');
                                    
                                                const myChart_{{ forloop.counter0 }} = new Chart(ctx_{{ forloop.counter0 }}, {
                                                    type: 'bar',
                                                    data: {
                                                        labels: labels_{{ forloop.counter0 }},
                                                        datasets: [
                                                            {
                                                                label: 'Expedientes Ingresos a Trámite',
                                                                data: datosIngresos_{{ forloop.counter0 }},
                                                                backgroundColor: 'rgba(250,127,94,0.3)',
                                                                borderColor: 'rgba(250,127,94,0.8)',
                                                                borderWidth: 1,
                                                            },
                                                            {
                                                                label: 'Expedientes Resueltos',
                                                                data: datosResueltos_{{ forloop.counter0 }},
                                                                backgroundColor: '#74e9f8',
                                                                borderColor: 'rgba(78,222,241,0.8)',
                                                                borderWidth: 1,
                                                            },
                                                        ],
                                                    },
                                                    options: {
                                                        indexAxis: 'y', // Barras horizontales
                                                        responsive: true,
                                                        plugins: {
                                                            legend: {
                                                                position: 'top',
                                                            },
                                                            datalabels: {
                                                                anchor: 'center',
                                                                align: 'center',
                                                                formatter: (value) => value,
                                                                color: 'dark',
                                                                font: {
                                                                    size: 12,
                                                                    weight: 'bold',
                                                                },
                                                            },
                                                        },
                                                        scales: {
                                                            x: {
                                                                beginAtZero: true,
                                                            },
                                                            y: {
                                                                ticks: {
                                                                    autoSkip: false, // Muestra todas las etiquetas
                                                                },
                                                                categoryPercentage: 0.5, // Reduce el espacio asignado a cada categoría
                                                                barPercentage: 0.3, // Hace las barras más delgadas dentro de la categoría
                                                                maxBarThickness: 10, // Establece un tamaño máximo para las barras (ajústalo según necesidad)
                                                            }
                                                        },
                                                        onClick: (e, activeElements) => {
                                                            if (activeElements.length > 0) {
                                                                const index = activeElements[0].index;
                                                                const instancia = myChart_{{ forloop.counter0 }}.data.labels[index];
                                                                const ingresos = myChart_{{ forloop.counter0 }}.data.datasets[0].data[index];
                                                                const resueltos = myChart_{{ forloop.counter0 }}.data.datasets[1].data[index];
                                    
                                                                // Muestra el modal con los datos
                                                                document.getElementById('detalleInstancia').innerHTML = `
                                                                    <div class="row">
                                                                        <div class="col-lg-12 col-12">
                                                                            <h3 class="text-center font-weight-bold">${instancia}</h3>
                                                                        </div>
                                                                        <div class="col-lg-6 col-12">
                                                                            <div class="card card-dark card-outline d-flex align-items-center justify-content-center text-center">
                                                                                <div class="card-body position-relative">
                                                                                    <h1>${ingresos}</h1>
                                                                                    <h5 class="font-weight-bold text-center">EXPEDIENTES INGRESADOS EN TRÁMITE</h5>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                    
                                                                        <div class="col-lg-6 col-12">
                                                                            <div class="card card-dark card-outline d-flex align-items-center justify-content-center text-center">
                                                                                <div class="card-body position-relative">
                                                                                    <h1>${resueltos}</h1>
                                                                                    <h5 class="font-weight-bold text-center">EXPEDIENTES RESUELTOS EN TRÁMITE</h5>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                `;
                                    
                                                                const modal = new bootstrap.Modal(document.getElementById('modalInstancia'));
                                                                modal.show();
                                                            }
                                                        },
                                                    },
                                                    plugins: [ChartDataLabels],
                                                });
                                            });
                                        </script>
                                    {% endfor %}
                                    
                                        </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </section>
{% endblock %}

{% block grafico_js %}
<script src="{% static 'base/vendor/apex-charts/apexcharts.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.3.1/decimal.min.js"></script>
<script src="{% static 'base/js/charts-chartjs.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
{% endblock %}

{% block script %}
<script>
    function mostrarDiaAnterior() {
        const ahora = new Date();  // Obtener la fecha actual
        const diaAnterior = new Date(ahora);  // Copiar la fecha actual
        diaAnterior.setDate(ahora.getDate() - 1);  // Restar un día

        // Formatear la fecha en español
        const fechaFormateada = diaAnterior.toLocaleDateString("es-ES", {

            year: "numeric",
            month: "long",    // Mes en texto
            day: "numeric",
        });

        // Mostrar la fecha en el elemento con id 'fecha_anterior'
        document.getElementById('fecha_anterior').textContent = fechaFormateada;
    }

    // Llamar a la función cuando la página cargue
    window.onload = mostrarDiaAnterior;


    /** =============================================================
    ======================= GRÁFICO CIRCULAR ========================
    ============================================================== */
    document.addEventListener("DOMContentLoaded", function () {
        const canvases = document.querySelectorAll(".progress-circle");
    
        canvases.forEach((canvas) => {
            const ctx = canvas.getContext("2d");
            const percentage = parseFloat(canvas.getAttribute("data-percentage")); // Ahora sí obtiene el porcentaje
            const x_nivel_produc = canvas.getAttribute("data-nivel-produc"); // Obtiene el nivel de producción
    
            if (isNaN(percentage)) return; // Si no es un número, no dibujar
    
            const radius = canvas.width / 2;
            const lineWidth = 15;
            const center = radius;
    
            ctx.lineWidth = lineWidth;
    
            // Dibuja el fondo del círculo
            ctx.beginPath();
            ctx.arc(center, center, radius - lineWidth, 0, 2 * Math.PI);
            ctx.strokeStyle = "#e6e6e6";
            ctx.stroke();
    
            // Determina el color del progreso
            let progressColor;
            switch (x_nivel_produc) {
                case "MUY BUENO":
                    progressColor = "#28a745"; // Verde
                    break;
                case "BUENO":
                    progressColor = "#ffc107"; // Amarillo
                    break;
                case "BAJO":
                    progressColor = "#f44336"; // Rojo
                    break;
                default:
                    progressColor = "#6c757d"; // Gris
            }
    
            // Dibuja el progreso
            const startAngle = -Math.PI / 2;
            const endAngle = startAngle + (percentage / 100) * 2 * Math.PI;
    
            ctx.beginPath();
            ctx.arc(center, center, radius - lineWidth, startAngle, endAngle);
            ctx.strokeStyle = progressColor;
            ctx.lineCap = "round";
            ctx.stroke();
        });
    });
    

</script>
{% endblock %}

