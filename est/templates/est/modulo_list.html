{% extends "base/base.html" %}
{% load static %}
{% block title %} Listar Módulos :: Estadistica {% endblock %}
{% block title_nav %} {% endblock  %}

{% block datatable_css %}
<link rel="stylesheet" href="{% static 'base/vendor/datatables/dt/datatables.bootstrap5.css' %}" />
<link rel="stylesheet" href="{% static 'base/vendor/datatables/responsive/responsive.bootstrap5.css' %}" />
<link rel="stylesheet" href="{% static 'base/vendor/datatables/checkboxes/datatables.checkboxes.css' %} "/>
{% endblock  %}

{% block body_container %}
{% comment %} ==========================================
    MODAL PARA AGREGAR AL JUEZ
========================================== {% endcomment %}
<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar Módulo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="x_nombre" class="form-label">Nombre del módulo</label>
                        <input type="text" id="x_nombre" name="x_nombre" class="form-control">
                    </div>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% comment %} ==========================================
    MODAL PARA ELIMINAR AL JUEZ
========================================== {% endcomment %}
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Eliminar Módulo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar este módulo?</p>
                <form method="POST" id="deleteForm">
                    {% csrf_token %}
                    <input type="hidden" id="delete_id" name="delete_id">
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% comment %} ==========================================
    MODAL PARA ELIMINAR AL JUEZ
========================================== {% endcomment %}
<div class="modal fade" id="restablecerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Restablecer Módulo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas restablecer este módulo?</p>
                <form method="POST" id="restablecerForm">
                    {% csrf_token %}
                    <input type="hidden" id="delete_id" name="delete_id">
                    <button type="submit" class="btn btn-danger">Restablecer</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% comment %} ==========================================
    MODAL PARA EDITAR AL JUEZ
========================================== {% endcomment %}
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Módulo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    {% csrf_token %}
                    <input type="hidden" id="edit_id">
                    <div class="mb-3">
                        <label for="edit_nombre" class="form-label">Nombre del módulo</label>
                        <input type="text" id="edit_nombre" name="x_nombre" class="form-control">
                    </div>
                    <button type="submit" class="btn btn-primary">Guardar cambios</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="container-xxl flex-grow-1 container-p-y">
    <div class="row">
        <div class="col-12">
            <div class="row mt-2">
                <div class="col-xxl-8 col-xl-6 col-lg-6 col-md-12 col-sm-12 col-12 mb-2">
                    <div class="card">
                        <div class="d-flex align-items-end row">
                            <div class="col-xxl-7 col-xl-7 col-md-7 col-sm-12">
                                <div class="card-body text-nowrap">
                                    <h2 class="card-title mb-0 font-weight-bold">Listar Módulos</h2>
                                    <p class="mb-2">Sistema de Estadistica / Listar Módulos</p>
                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">
                                        Agregar Módulos
                                    </button>
                                </div>
                            </div>

                            <div class="col-xxl-5 col-xl-5 col-md-5 d-none d-sm-none d-lg-block text-center">
                                <div class="card-body pb-0">
                                <img
                                    src="{% static "base/img/Svg/modulos.svg" %}"
                                    class="img-fluid" width="120"
                                    alt="Módulos"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-6">
                    <div class="card h-100">
                        <div class="card-body pt-5 mb-0 pb-0 text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="45" viewBox="0 0 512 512"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/></svg>
                            <h5 class="mb-0 mt-3">Módulos Activos</h5>
                            <h4 class="font-weight-bold card-title mb-0">{{ count_femenino }}</h4>
                        </div>
                    </div>
                </div>

                <div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-6">
                    <div class="card h-100">
                        <div class="card-body pt-5 mb-0 pb-0 text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="45" viewBox="0 0 512 512"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM175 175c9.4-9.4 24.6-9.4 33.9 0l47 47 47-47c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9l-47 47 47 47c9.4 9.4 9.4 24.6 0 33.9s-24.6 9.4-33.9 0l-47-47-47 47c-9.4 9.4-24.6 9.4-33.9 0s-9.4-24.6 0-33.9l47-47-47-47c-9.4-9.4-9.4-24.6 0-33.9z"/></svg>
                            <h5 class="mb-0 mt-3">Módulos Inactivos</h5>
                            <h4 class="font-weight-bold card-title mb-0">{{ count_femenino }}</h4>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Users List Table -->
            
                <section id="modulo-lista mt-3">
                        <div class="row">
                            {% for modulo in modulos %}                       
                            <div class="col-md-6 col-lg-3 mt-3" >
                                <div class="card h-100">
                                    
                                    <div class="card-body p-6">
                                        <h5 class="card-title text-center mb-0">{{modulo.x_nombre}}</h5>
                                        <div class="text-center">
                                            {% if modulo.l_activo == "S" %}
                                        <span class="badge bg-label-success"> ACTIVO </span>
                                        {% else %}
                                        <span class="badge bg-label-danger"> INACTIVO </span>
                                        {% endif %}
                                        </div>

                                        <div class="d-flex justify-content-center align-items-center gap-2 mt-2">
                                            {% if modulo.l_activo == "S" %}
                                            <a href="{% url 'est:modulo_instancia_list' modulo_id=modulo.n_id_modulo %}"><button class="btn px-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" style="margin-left:5px" viewBox="0 0 512 512">
                                                <path fill="currentColor" d="M48 0C21.5 0 0 21.5 0 48L0 464c0 26.5 21.5 48 48 48l96 0 0-80c0-26.5 21.5-48 48-48s48 21.5 48 48l0 80 96 0c26.5 0 48-21.5 48-48l0-416c0-26.5-21.5-48-48-48L48 0zM64 240c0-8.8 7.2-16 16-16l32 0c8.8 0 16 7.2 16 16l0 32c0 8.8-7.2 16-16 16l-32 0c-8.8 0-16-7.2-16-16l0-32zm112-16l32 0c8.8 0 16 7.2 16 16l0 32c0 8.8-7.2 16-16 16l-32 0c-8.8 0-16-7.2-16-16l0-32c0-8.8 7.2-16 16-16zm80 16c0-8.8 7.2-16 16-16l32 0c8.8 0 16 7.2 16 16l0 32c0 8.8-7.2 16-16 16l-32 0c-8.8 0-16-7.2-16-16l0-32zM80 96l32 0c8.8 0 16 7.2 16 16l0 32c0 8.8-7.2 16-16 16l-32 0c-8.8 0-16-7.2-16-16l0-32c0-8.8 7.2-16 16-16zm80 16c0-8.8 7.2-16 16-16l32 0c8.8 0 16 7.2 16 16l0 32c0 8.8-7.2 16-16 16l-32 0c-8.8 0-16-7.2-16-16l0-32zM272 96l32 0c8.8 0 16 7.2 16 16l0 32c0 8.8-7.2 16-16 16l-32 0c-8.8 0-16-7.2-16-16l0-32c0-8.8 7.2-16 16-16z"/></svg>
                                                </button>
                                            </a>
                                    
                                            <button class="btn px-2" data-bs-toggle="modal" data-bs-target="#editModal" data-id="{{ modulo.n_id_modulo }}" data-nombre="{{ modulo.x_nombre }}">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="15" viewBox="0 0 512 512">
                                                    <path fill="currentColor" d="M410.3 231l11.3-11.3-33.9-33.9-62.1-62.1L291.7 89.8l-11.3 11.3-22.6 22.6L58.6 322.9c-10.4 10.4-18 23.3-22.2 37.4L1 480.7c-2.5 8.4-.2 17.5 6.1 23.7s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L387.7 253.7 410.3 231zM160 399.4l-9.1 22.7c-4 3.1-8.5 5.4-13.3 6.9L59.4 452l23-78.1c1.4-4.9 3.8-9.4 6.9-13.3l22.7-9.1 0 32c0 8.8 7.2 16 16 16l32 0zM362.7 18.7L348.3 33.2 325.7 55.8 314.3 67.1l33.9 33.9 62.1 62.1 33.9 33.9 11.3-11.3 22.6-22.6 14.5-14.5c25-25 25-65.5 0-90.5L453.3 18.7c-25-25-65.5-25-90.5 0zm-47.4 168l-144 144c-6.2 6.2-16.4 6.2-22.6 0s-6.2-16.4 0-22.6l144-144c6.2-6.2 16.4-6.2 22.6 0s6.2 16.4 0 22.6z"/>
                                                </svg>
                                            </button>

                                            <button class="btn px-2" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#deleteModal" 
                                                    data-id="{{ modulo.n_id_modulo }}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="15" viewBox="0 0 448 512"><path fill="currentColor" d="M135.2 17.7C140.6 6.8 151.7 0 163.8 0L284.2 0c12.1 0 23.2 6.8 28.6 17.7L320 32l96 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L32 96C14.3 96 0 81.7 0 64S14.3 32 32 32l96 0 7.2-14.3zM32 128l384 0 0 320c0 35.3-28.7 64-64 64L96 512c-35.3 0-64-28.7-64-64l0-320zm96 64c-8.8 0-16 7.2-16 16l0 224c0 8.8 7.2 16 16 16s16-7.2 16-16l0-224c0-8.8-7.2-16-16-16zm96 0c-8.8 0-16 7.2-16 16l0 224c0 8.8 7.2 16 16 16s16-7.2 16-16l0-224c0-8.8-7.2-16-16-16zm96 0c-8.8 0-16 7.2-16 16l0 224c0 8.8 7.2 16 16 16s16-7.2 16-16l0-224c0-8.8-7.2-16-16-16z"/></svg>
                                            </button>
                                            {% else %}
                                            <button class="btn px-2" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#restablecerModal" 
                                                    data-id="{{ modulo.n_id_modulo }}">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="15" viewBox="0 0 640 640">
                                                    <path d="M320 128C263.2 128 212.1 152.7 176.9 192L224 192C241.7 192 256 206.3 256 224C256 241.7 241.7 256 224 256L96 256C78.3 256 64 241.7 64 224L64 96C64 78.3 78.3 64 96 64C113.7 64 128 78.3 128 96L128 150.7C174.9 97.6 243.5 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C233 576 156.1 532.6 109.9 466.3C99.8 451.8 103.3 431.9 117.8 421.7C132.3 411.5 152.2 415.1 162.4 429.6C197.2 479.4 254.8 511.9 320 511.9C426 511.9 512 425.9 512 319.9C512 213.9 426 128 320 128z"/>
                                                </svg>
                                                Activar
                                            </button>
                                            {% endif %}
                                            
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                </section>
            
        </div>
    </div>
</div>
{% endblock %}

{% block datatable_js %}
<script src="{% static 'base/vendor/datatables5/datatables-bootstrap5.js' %}"></script>
{% endblock %}

{% block datatable %}
<script>
    $(document).ready(function () {
        $('#TableModulos').DataTable({
            "pageLength": 15,
            "lengthMenu": [[15, 30, 50, 100, -1], [15, 30, 50, 100, "Todos"]],
            autoWidth: false,
            destroy: true,
            responsive: true,
            dom: '<"row mb-3"<"col-md-3"l><"col-md-6 text-center"B><"col-md-3"f>>t<"row"<"col-md-6"i><"col-md-6"p>>',
            buttons: [
                {
                    extend: 'collection',
                    text: '<i class="fa fa-download"></i> Exportar Tabla',
                    className: 'btn btn-danger mt-6',
                    buttons: [
                        { extend: 'print', text: '<i class="fa fa-print"></i> Imprimir' },
                        { extend: 'csv', text: '<i class="fa fa-file-csv"></i> Archivo CSV' },
                        { extend: 'excel', text: '<i class="fa fa-file-excel"></i> Archivo Excel' },
                        { extend: 'pdf', text: '<i class="fa fa-file-pdf"></i> Archivo PDF' },
                        { extend: 'copy', text: '<i class="fa fa-copy"></i> Copiar' }
                    ]
                }
            ],
            language: {
                "sProcessing": "Procesando...",
                "sLengthMenu": "Mostrar _MENU_ registros",
                "sZeroRecords": "No se encontraron resultados",
                "sEmptyTable": "Ningún dato disponible en esta tabla",
                "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                "sSearch": "Buscar:",
                "oPaginate": {
                    "sFirst": "Primero",
                    "sLast": "Último",
                    "sNext": "Siguiente",
                    "sPrevious": "Anterior"
                },
                "oAria": {
                    "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                    "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                }
            },
        });
    });
</script>
{% endblock  %}

{% block script %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === name + "=") {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrftoken = getCookie("csrftoken");
    
    $.ajaxSetup({
        headers: {
            "X-CSRFToken": csrftoken,
        },
    });    


    $("#createForm").submit(function (e) {
        e.preventDefault();
        $.ajax({
            url: "{% url 'est:modulo_create' %}",
            method: "POST",
            data: $(this).serialize(),
            success: function (response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert("Error: " + JSON.stringify(response.errors));
                }
            }
        });
    });

    // Editar módulo
    $("#editModal").on("show.bs.modal", function (event) {
        const button = $(event.relatedTarget);
        const id = button.data("id");
        const nombre = button.data("nombre");
        $("#edit_id").val(id);
        $("#edit_nombre").val(nombre);
    });

    $("#editForm").submit(function (e) {
        e.preventDefault();
        const id = $("#edit_id").val();
        $.ajax({
            url: `../../est/Modulo/update/${id}/`,
            method: "POST",
            data: $(this).serialize(),
            success: function (response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert("Error: " + JSON.stringify(response.errors));
                }
            }
        });
    });

    // Eliminar módulo
    $("#deleteModal").on("show.bs.modal", function (event) {
        const button = $(event.relatedTarget);
        const id = button.data("id");
        $("#delete_id").val(id);
    });
    
    $("#deleteForm").submit(function (e) {
        e.preventDefault();
        const id = $("#delete_id").val();
        $.ajax({
            url: `../../est/Modulo/delete/${id}/`,
            method: "POST",
            success: function (response) {
                if (response.success) {
                    location.reload();
                }
            },
        });
    });

    // Eliminar módulo
    $("#restablecerModal").on("show.bs.modal", function (event) {
        const button = $(event.relatedTarget);
        const id = button.data("id");
        $("#delete_id").val(id);
    });
    
    $("#restablecerForm").submit(function (e) {
        e.preventDefault();
        const id = $("#delete_id").val();
        $.ajax({
            url: `../../est/Modulo/activar/${id}/`,
            method: "POST",
            success: function (response) {
                if (response.success) {
                    location.reload();
                }
            },
        });
    });
    
</script>
{% endblock  %}