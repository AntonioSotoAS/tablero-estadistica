{% extends "base/base.html" %}
{% load static %}

{% block title %} Metas - Resúmenes {% endblock %}

{% block alertas_css %}
<link rel="stylesheet" href="{% static 'base/vendor/sweetalert2/sweetalert2.css'%}" />
{% endblock  %}

{% block datatable_css %}
<link rel="stylesheet" href="{% static 'base/vendor/datatables/dt/datatables.bootstrap5.css' %}" />
<link rel="stylesheet" href="{% static 'base/vendor/datatables/responsive/responsive.bootstrap5.css' %}" />
<link rel="stylesheet" href="{% static 'base/vendor/datatables/checkboxes/datatables.checkboxes.css' %} "/>
{% endblock  %}

{% block body_container %}

<style>
  .tabla-borde-negro { --bs-border-color: #000; }

  /* Toggle Sí/No compacto para tablas */
  .toggle {
    --h: 22px; --w: 54px; --pad: 2px; --knob: calc(var(--h) - var(--pad)*2);
    position: relative; display: inline-block; width: var(--w); height: var(--h);
  }
  .toggle input { display:none; }
  .toggle .track{
    position:absolute; inset:0; border-radius:999px; background:#e5e7eb; 
    border:1px solid #d1d5db; transition:.2s ease;
  }
  .toggle .knob{
    position:absolute; top:var(--pad); left:var(--pad);
    width:var(--knob); height:var(--knob); border-radius:50%;
    background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.15);
    transition:left .2s ease;
  }
  .toggle .label{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    font-size:11px; font-weight:600; color:#4b5563; user-select:none; pointer-events:none;
  }
  .toggle input:checked ~ .track{ background:#16a34a33; border-color:#16a34a;}
  .toggle input:checked ~ .label{ color:#065f46;}
  .toggle input:checked ~ .knob{ left: calc(100% - var(--pad) - var(--knob)); }
  .toggle[data-text="si-no"] .label::before{ content:"No"; }
  .toggle[data-text="si-no"] input:checked ~ .label::before{ content:"Sí"; }

  /* versión XS para celdas apretadas */
  .toggle.toggle-xs{ --h:18px; --w:44px; }
  .toggle.toggle-sm{ --h:20px; --w:50px; }
</style>

<div class="container mt-5">

  <div class="card mt-3">
<div class="card-header">
  <div class="row">
    <div class="col-12 justify-content-center">
      <h2 class="mb-0 fw-bold text-center">Metas Resúmenes — {{ mes_nombre }} {{ anio }} de {{ year }}</h2>
    </div>

    <div class="col-12 d-flex justify-content-center">
      {% if vista == 'modificado' %}
        {% if items and items.0.l_estado == 'C' %}
          <div class="d-flex gap-2">
            <form id="frmVolverAbr" method="post" action="{% url 'est:meta_resumen_volver_abrir' %}" class="d-inline">
              {% csrf_token %}
              <input type="hidden" name="year" value="{{ year }}">
              <input type="hidden" name="month" value="{{ month }}">
              <button type="submit" class="btn btn-label-danger">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" viewBox="0 0 640 640">
                  <path fill="currentColor" d="M416 160C416 124.7 444.7 96 480 96C515.3 96 544 124.7 544 160L544 192C544 209.7 558.3 224 576 224C593.7 224 608 209.7 608 192L608 160C608 89.3 550.7 32 480 32C409.3 32 352 89.3 352 160L352 224L192 224C156.7 224 128 252.7 128 288L128 512C128 547.3 156.7 576 192 576L448 576C483.3 576 512 547.3 512 512L512 288C512 252.7 483.3 224 448 224L416 224L416 160z"/>
                </svg>
                Volver a Abrir</button>
            </form>
          </div>
          {% else %}
          <div class="d-flex gap-2">
            <button id="btnGuardarTodo" class="btn btn-label-success">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" viewBox="0 0 640 640">
                <path fill="currentColor" d="M160 96C124.7 96 96 124.7 96 160L96 480C96 515.3 124.7 544 160 544L480 544C515.3 544 544 515.3 544 480L544 237.3C544 220.3 537.3 204 525.3 192L448 114.7C436 102.7 419.7 96 402.7 96L160 96zM192 192C192 174.3 206.3 160 224 160L384 160C401.7 160 416 174.3 416 192L416 256C416 273.7 401.7 288 384 288L224 288C206.3 288 192 273.7 192 256L192 192zM320 352C355.3 352 384 380.7 384 416C384 451.3 355.3 480 320 480C284.7 480 256 451.3 256 416C256 380.7 284.7 352 320 352z"/></svg><path d="M160 96C124.7 96 96 124.7 96 160L96 480C96 515.3 124.7 544 160 544L480 544C515.3 544 544 515.3 544 480L544 237.3C544 220.3 537.3 204 525.3 192L448 114.7C436 102.7 419.7 96 402.7 96L160 96zM192 192C192 174.3 206.3 160 224 160L384 160C401.7 160 416 174.3 416 192L416 256C416 273.7 401.7 288 384 288L224 288C206.3 288 192 273.7 192 256L192 192zM320 352C355.3 352 384 380.7 384 416C384 451.3 355.3 480 320 480C284.7 480 256 451.3 256 416C256 380.7 284.7 352 320 352z"/>
              </svg>
              Guardar todo
            </button>
            <form id="frmCerrarDef" method="post" action="{% url 'est:meta_resumen_cerrar_definitivo' %}" class="d-inline">
              {% csrf_token %}
              <input type="hidden" name="year" value="{{ year }}">
              <input type="hidden" name="month" value="{{ month }}">
              <button type="submit" class="btn btn-label-danger">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" viewBox="0 0 640 640">
                  <path fill="currentColor" d="M256 160L256 224L384 224L384 160C384 124.7 355.3 96 320 96C284.7 96 256 124.7 256 160zM192 224L192 160C192 89.3 249.3 32 320 32C390.7 32 448 89.3 448 160L448 224C483.3 224 512 252.7 512 288L512 512C512 547.3 483.3 576 448 576L192 576C156.7 576 128 547.3 128 512L128 288C128 252.7 156.7 224 192 224z"/>
                </svg>
                Cerrado definitivo</button>
            </form>
          </div>
        {% endif %}
        {% else %}
          <form id="frmCrearSnapshot" method="post" action="{% url 'est:crear_snapshot_temporal' %}" class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="year" value="{{ year }}">
            <input type="hidden" name="month" value="{{ month }}">
            <button type="submit" class="btn btn-warning btn-sm">Crear versión temporal</button>
          </form>
      {% endif %}
    </div>
  </div>
</div>

  </div>
  <div class="card mt-3">
    <div class="card-body py-2">
      <form class="row g-2 align-items-end" method="get" action="">
        <div class="col-auto">
          <label for="period" class="form-label mb-0">Periodo</label>
          <input
            type="month"
            id="period"
            name="period"
            class="form-control form-control-sm"
            value="{{ year }}-{{ month|add:'0'|slice:'-2' }}"
            />
        </div>

        <div class="col-auto">
          <button type="submit" class="btn btn-primary btn-sm">Ver</button>
        </div>

        <div class="col-auto">
          <!-- Limpia filtros y vuelve al mes actual (sin parámetros) -->
          <a href="{% url 'est:meta_resumen_b_list' %}" class="btn btn-outline-secondary btn-sm">
            Mes actual
          </a>
        </div>

        <div class="col-auto text-muted small">
          Mostrando: <strong>{{ mes_nombre }} {{ year }}</strong>
        </div>
      </form>
    </div>
  </div>

  
</div>

  <div class="container-fluid">
  <!-- Tabla -->
  <div class="card mt-5">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered border-dark" id="tablaMetaResumen">
          <thead class="table-light">
            <tr>
              <th style="font-size:10px; background: #16365C;" class="text-white text-center px-1">#</th>
              <th style="font-size:10px; background: #16365C;" class="text-white text-center px-1">DEPENDENCIA</th>
              <th style="font-size:10px; background: #16365C;" class="text-white text-center px-1">ESTANDAR DE PRODUC.</th>
              <th style="font-size:10px; background: #595959" class="text-white text-center px-1">CARGA PROCESAL INICIAL EN TRAMITE {{ year }}</th>
              <th style="font-size:10px; background: #16365C;" class="text-white text-center px-1">ING. <br> TOTAL</th>
              <th style="font-size:10px; background: #16365C;" class="text-white text-center px-1">INGRESOS PROYECTADOS</th>
              <th style="font-size:10px; background: #595959" class="text-white text-center px-1">CARGA PROCESAL EN TRÁMITE {{ year }}</th>
              <th style="font-size:10px; background: #4F6228;" class="text-white text-center px-1">CARGA PROCESAL MÍNIMA ANUAL</th>
              <th style="font-size:10px; background: #4F6228;" class="text-white text-center px-1">CARGA PROCESAL MÁXIMA ANUAL</th>
              <th style="font-size:10px; background: #C00000;" class="text-white text-center px-1">META <br>PRELIMINAR <br>PROYECTADA {{ year }}</th>
              <th style="font-size:10px; background: #16365C;" class="text-white text-center px-1">SITUACIÓN <br>DE LA CARGA <br> EN TRÁMITE</th>
              <th style="font-size:10px; background: #4BACC6;" class="text-white text-center px-1">OTROS <br>EGRESOS <br>A OTRA DEP.</th>
              <th style="font-size:10px; background: #538DD5;" class="text-white text-center px-1">ACTIVAR egresos</th>
              <th style="font-size:10px; background: #4BACC6;" class="text-white text-center px-1">INGRESOS DE OTRA DEP.</th>
              <th style="font-size:10px; background: #538DD5;" class="text-white text-center px-1">ACTIVAR ingresos</th>
              <th style="font-size:10px; background: #4BACC6;" class="text-white text-center px-1">PEND. EN RESERVA</th>
              <th style="font-size:10px; background: #538DD5;" class="text-white text-center px-1">ACTIVAR pendiente</th>
              <th style="background: #16365C;  font-size:10px;" class="text-white text-center px-1">VALOR <br>AGREGADO</th>
              <th style="background: #16365C;  font-size:10px;" class="text-white text-center px-1">VALOR <br>OPJ</th>
            </tr>
          </thead>

          <tbody>
          {% if vista == 'base' %}
            {# ======== SOLO LECTURA (BASE) ======== #}
            {% for r in items %}
            <tr
              data-tram-ini="{{ r.n_carg_procesal_ini }}"
              data-ingreso="{{ r.m_t_ingreso }}"
              data-pendmes="{{ r.m_pend_reserva|default:0 }}"

              data-febrero-bd="{{ r.ingreso_mes_feb|default:r.m_t_ingreso_mes|default:0 }}"
              data-ingajus="{{ r.m_t_ingreso_mes|default:0 }}"

              data-egreajus="{{ r.egre_ajustado_feb|default:0 }}"

              data-ingproy-bd="{{ r.m_ing_proyectado|default:0 }}"
              data-carga-bd="{{ r.m_carg_procesal_tram|default:0 }}"
            >
              <td style="font-size:11px">{{ forloop.counter }}</td>
              <td style="font-size:11px;" class="bg-label-info text-dark">{{ r.n_instancia.x_nom_instancia }}</td>
              <td style="font-size:11px">{{ r.m_estandar_prod }}</td>
              <td style="font-size:11px;background:#D9D9D9" class="text-dark text-center">{{ r.n_carg_procesal_ini }}</td>
              <td style="font-size:11px" class="td-ing-total">{{ r.m_t_ingreso }}</td>
              <td style="font-size:11px" class="td-ing-proy">{{ r.m_ing_proyectado }}</td>
              <td class="text-dark text-center td-carga" style="font-size:11px;background:#D9D9D9">{{ r.m_carg_procesal_tram }}</td>
              <td style="font-size:11px;background: #D8E4BC" class="text-dark text-center">{{ r.m_carg_procesal_min }}</td>
              <td style="font-size:11px;background: #D8E4BC" class="text-dark text-center">{{ r.m_carg_procesal_max }}</td>
              <td class="text-dark text-center" style="font-size:11px; background:#E6B8B7">{{ r.m_meta_preliminar }}</td>

              <td class="td-situacion text-dark text-center
                {% if r.x_situacion_carga == 'SOBRECARGA' %} bg-danger text-white
                {% elif r.x_situacion_carga == 'SUBCARGA' %} bg-success text-white
                {% elif r.x_situacion_carga == 'ESTANDAR' %} bg-warning
                {% endif %}" style="font-size:11px;">
                {{ r.x_situacion_carga }}
              </td>

              <td style="font-size:11px;" class="text-center">{{ r.m_egre_otra_dep|default:"0" }}</td>
              <td class="text-center">—</td>
              <td style="font-size:11px" class="text-center">{{ r.m_ing_otra_dep }}</td>
              <td class="text-center">—</td>
              <td style="font-size:11px" class="text-center">{{ r.m_pend_reserva }}</td>
              <td class="text-center">—</td>
              <td style="font-size:11px;">—</td>
              <td style="font-size:11px;">—</td>
            </tr>
            {% empty %}
              <tr><td colspan="19" class="text-center text-muted py-4">Sin registros</td></tr>
            {% endfor %}

          {% else %}
            {# ======== EDITABLE (MODIFICADO) ======== #}
            {% for r in items %}
            <tr
              data-pk="{{ r.n_id_meta_resumen_mod }}"
              data-tram-ini="{{ r.n_carg_procesal_ini }}"
              data-ingreso="{{ r.m_t_ingreso }}"
              data-pendmes="{{ r.m_pend_reserva|default:0 }}"

              data-febrero-bd="{{ r.ingreso_mes_feb|default:0 }}"
              data-ingajus="{{ r.ingreso_mes_feb|default:0 }}"

              data-egreajus="{{ r.egre_ajustado_feb|default:0 }}"

              data-ingproy-bd="{{ r.m_ing_proyectado|default:0 }}"
              data-carga-bd="{{ r.m_carg_procesal_tram|default:0 }}"
            >
              <td style="font-size:11px">{{ forloop.counter }}</td>
              <td style="font-size:11px;" class="bg-label-info text-dark">{{ r.n_instancia.x_nom_instancia }}</td>
              <td style="font-size:11px">{{ r.m_estandar_prod }}</td>
              <td style="font-size:11px;background:#D9D9D9" class="text-dark text-center td-tram-ini">{{ r.n_carg_procesal_ini }}</td>
              <td style="font-size:11px" class="td-ing-total">{{ r.m_t_ingreso }}</td>
              <td style="font-size:11px" class="td-ing-proy">{{ r.m_ing_proyectado }}</td>
              <td class="text-dark text-center td-carga" style="font-size:11px;background:#D9D9D9">{{ r.m_carg_procesal_tram }}</td>
              <td style="font-size:11px;background:#D8E4BC" class="text-dark text-center">{{ r.m_carg_procesal_min }}</td>
              <td style="font-size:11px;background:#D8E4BC" class="text-dark text-center">{{ r.m_carg_procesal_max }}</td>
              <td class="text-dark text-center meta-preliminar" data-meta-base="{{ r.m_meta_preliminar }}" style="font-size:11px; background:#E6B8B7">
                {{ r.m_meta_preliminar }}
              </td>

              <td class="td-situacion text-dark text-center
                {% if r.x_situacion_carga == 'SOBRECARGA' %} bg-danger text-white
                {% elif r.x_situacion_carga == 'SUBCARGA' %} bg-success text-white
                {% elif r.x_situacion_carga == 'ESTANDAR' %} bg-warning
                {% endif %}" style="font-size:11px;">
                {{ r.x_situacion_carga }}
              </td>

              <td style="font-size:11px;" class="text-center td-egre-otra">{{ r.m_egre_otra_dep|default:"0" }}</td>
              <td class="text-center" style="background: #C5D9F1">
                <div class="text-center">
                  <input class="form-check-input chk-op-egre" type="checkbox" data-inst="{{ r.n_instancia_id }}" {% if r.m_op_egre_otra_dep %}checked{% endif %}>
                </div>
              </td>
              <td style="font-size:11px" class="text-center td-ing-otra">{{ r.m_ing_otra_dep }}</td>
              <td class="text-center" style="background: #C5D9F1">
                <div class="text-center">
                  <input class="form-check-input chk-op-ing" type="checkbox" data-inst="{{ r.n_instancia_id }}" {% if r.m_op_ing_otra_dep %}checked{% endif %}>
                </div>
              </td>
              <td style="font-size:11px" class="text-center td-pend-mes">{{ r.m_pend_reserva }}</td>
              <td class="text-center" style="background: #C5D9F1">
                <div class="text-center">
                  <input class="form-check-input chk-op-pend" type="checkbox" data-inst="{{ r.n_instancia_id }}" {% if r.m_op_pend_reserva %}checked{% endif %}>
                </div>
              </td>

              <td style="font-size:11px; width:120px;">
                <input type="number" class="form-control form-control-sm txt-valor-agregado"
                       value="{{ r.n_valor_modificado|default_if_none:'' }}"
                       placeholder="0" step="1">
              </td>
              <td style="font-size:11px; width:120px;">
                <input type="number" class="form-control form-control-sm txt-meta-opj"
                       value="{{ r.n_meta_opj|default_if_none:'' }}"
                       placeholder="0" step="1">
              </td>
            </tr>
            {% empty %}
              <tr><td colspan="19" class="text-center text-muted py-4">Sin registros</td></tr>
            {% endfor %}
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block datatable_js %}
<script src="{% static 'base/vendor/datatables5/datatables-bootstrap5.js' %}"></script>
{% endblock %}

{% block datatable %}
<script>
  $(document).ready(function(){
    $('.table').DataTable({
      pageLength: 15,
      lengthMenu: [[15,30,50,100,-1],[15,30,50,100,"Todos"]],
      autoWidth: false,
      responsive: false,
      scrollX: true,
      language: {
        sProcessing: "Procesando...",
        sLengthMenu: "Mostrar _MENU_ registros",
        sZeroRecords: "No se encontraron resultados",
        sEmptyTable: "Ningún dato disponible en esta tabla",
        sInfo: "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
        sInfoEmpty: "Mostrando registros del 0 al 0 de un total de 0 registros",
        sInfoFiltered: "(filtrado de un total de _MAX_ registros)",
        sSearch: "Buscar:",
        oPaginate: { sFirst:"Primero", sLast:"Último", sNext:"Siguiente", sPrevious:"Anterior" },
        oAria: { sSortAscending: ": Orden asc", sSortDescending: ": Orden desc" }
      }
    });

    // BASE: crear snapshot → reload
    $('#frmCrearSnapshot').on('submit', function(e){
      e.preventDefault();
      const $f = $(this);
      $.post($f.attr('action'), $f.serialize())
       .done(()=> location.reload())
       .fail(()=> alert('No se pudo crear la versión temporal'));
    });

    // MODIFICADO: cierre definitivo → reload
    $('#frmCerrarDef').on('submit', function(e){
      e.preventDefault();
      const $f = $(this);
      $.post($f.attr('action'), $f.serialize())
       .done(()=> location.reload())
       .fail(()=> alert('No se pudo cerrar definitivamente'));
    });

    // MODIFICADO: cierre definitivo → reload
    $('#frmVolverAbr').on('submit', function(e){
      e.preventDefault();
      const $f = $(this);
      $.post($f.attr('action'), $f.serialize())
       .done(()=> location.reload())
       .fail(()=> alert('No se pudo Abrir nuevamente'));
    });
  });
</script>
{% endblock %}

{% block alerts_js %}
<script src="{% static 'base/vendor/sweetalert2/sweetalert2.js' %}"></script>
{% endblock %}

{% block script %}
<script>
  // ---- CSRF ----
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // ---- Vista actual (solo informativo) ----
  const VISTA = "{{ vista|default:'base' }}";

  // ---- Parámetros de periodo ----
  const MES_ACTUAL_SIN_FEB = {{ mes_actual_sin_feb|default:0 }};
  const MESES_FALTA        = {{ meses_falta|default:0 }};

  // ---- Debug ----
  const DEBUG = true;

  // ---- SweetAlert helpers ----
  function swalOk(texto='Operación exitosa', titulo='¡Listo!') {
    return Swal.fire({ icon: 'success', title: titulo, text: texto, timer: 2000, showConfirmButton: false });
  }
  function swalWarn(texto='Revisa los datos', titulo='Atención') {
    return Swal.fire({ icon: 'warning', title: titulo, text: texto });
  }
  function swalInfo(texto='Información', titulo='Aviso') {
    return Swal.fire({ icon: 'info', title: titulo, text: texto, timer: 2000, showConfirmButton: false });
  }
  function swalErr(texto='Ocurrió un error inesperado', titulo='Ups…') {
    return Swal.fire({ icon: 'error', title: titulo, text: texto });
  }

  // ---- Utils ----
  function toInt(v){
    if(v===''||v===null||v===undefined) return 0;
    v=(''+v).replace(/[^\d-]/g,'');
    const n=parseInt(v,10);
    return isNaN(n)?0:n;
  }
  function formatMiles(n){
    return (''+n).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  }
  function setCellIfChanged($td, newValue) {
    const formatted = formatMiles(newValue);
    const prev = $td.data('prev');
    if (prev === undefined) {
      $td.text(formatted).data('prev', newValue).removeClass('font-weight-bold fs-5');
      return;
    }
    if (prev !== newValue) $td.text(formatted).addClass('font-weight-bold fs-5');
    else $td.text(formatted).removeClass('font-weight-bold fs-5');
    $td.data('prev', newValue);
  }
  function getNumFromCell($tr, selector){
    const $el = $tr.find(selector);
    if (!$el.length) return 0;
    const raw = $el.text() || $el.val() || '0';
    return toInt(raw);
  }

  // ---- DataTable / flags ----
  let dtMeta = null;
  const TABLE_ID = '#tablaMetaResumen';
  let SKIP_RECALC = false;

  // ---- Recalcular fila ----
  function recalcRow($tr){
    if (SKIP_RECALC) return;

    const pk = $tr.data('pk') || $tr.attr('data-pk') || null;

    // Datos base por fila
    const n_carg_procesal_ini = toInt($tr.attr('data-tram-ini'));
    const m_t_ingreso         = toInt($tr.attr('data-ingreso'));
    const pend_reserva_mes    = toInt($tr.attr('data-pendmes'));

    // FEBRERO_TOTAL (desde vista): preferimos data-febrero-bd; si no, data-ingajus
    const febAttr             = $tr.attr('data-febrero-bd');
    const ingajusAttr         = $tr.attr('data-ingajus');
    const m_t_ingreso_mes     = (febAttr !== undefined) ? toInt(febAttr) : toInt(ingajusAttr) || 0;

    if (DEBUG) console.log(`[MetaResumen] pk=${pk} :: m_t_ingreso_mes (vista)=`, m_t_ingreso_mes);

    // Switches
    const opEgre = $tr.find('.chk-op-egre').is(':checked'); // egresos otra dep
    const opIng  = $tr.find('.chk-op-ing').is(':checked');  // ingresos otra dep
    const opPend = $tr.find('.chk-op-pend').is(':checked'); // pendiente en reserva

    // Insumos mostrados en celdas
    const m_egre_otra_dep = getNumFromCell($tr, '.td-egre-otra');
    const m_ing_otra_dep  = getNumFromCell($tr, '.td-ing-otra');

    // Valores de BD cacheados
    const m_ing_proy_bd = toInt($tr.attr('data-ingproy-bd'));
    const m_carga_bd    = toInt($tr.attr('data-carga-bd'));

    const $tdIngProy = $tr.find('.td-ing-proy');
    const $tdCarga   = $tr.find('.td-carga');

    // --- 1) m_ing_proyectado ---
    let m_ing_proy_usado = m_ing_proy_bd;
    if (opEgre || opIng) {
      let proy = 0;
      if (MES_ACTUAL_SIN_FEB > 0) {
        const numerador = (m_t_ingreso - m_t_ingreso_mes)
                        - (opEgre ? m_egre_otra_dep : 0)
                        - (opIng  ? m_ing_otra_dep  : 0);
        proy = Math.round((numerador / MES_ACTUAL_SIN_FEB) * MESES_FALTA);
        if (proy < 0) proy = 0;
      }
      m_ing_proy_usado = proy;
      if ($tdIngProy.length) setCellIfChanged($tdIngProy, proy);
      if (DEBUG) console.log(`[MetaResumen] pk=${pk} :: m_ing_proyectado (recalc)=`, m_ing_proy_usado);
    } else {
      if ($tdIngProy.length) setCellIfChanged($tdIngProy, m_ing_proy_bd);
      if (DEBUG) console.log(`[MetaResumen] pk=${pk} :: m_ing_proyectado (BD)=`, m_ing_proy_bd);
    }

    // --- 2) m_carg_procesal_tram ---
    if (opPend) {
      const carga = (n_carg_procesal_ini + m_t_ingreso + m_ing_proy_usado) - pend_reserva_mes;
      if ($tdCarga.length) setCellIfChanged($tdCarga, carga);
      if (DEBUG) console.log(`[MetaResumen] pk=${pk} :: m_carg_procesal_tram (recalc con pendiente)=`, carga);
      return;
    }
    if (!opEgre && !opIng) {
      if ($tdCarga.length) setCellIfChanged($tdCarga, m_carga_bd);
      if (DEBUG) console.log(`[MetaResumen] pk=${pk} :: m_carg_procesal_tram (BD)=`, m_carga_bd);
    } else {
      const carga = (n_carg_procesal_ini + m_t_ingreso + m_ing_proy_usado);
      if ($tdCarga.length) setCellIfChanged($tdCarga, carga);
      if (DEBUG) console.log(`[MetaResumen] pk=${pk} :: m_carg_procesal_tram (recalc sin pendiente)=`, carga);
    }
  }

  // ---- Eventos: switches / inputs ----
  $(document).on('change', '.chk-op-egre, .chk-op-ing, .chk-op-pend', function(){
    recalcRow($(this).closest('tr'));
  });
  $(document).on('input', '.txt-valor-agregado, .txt-meta-opj', function(){
    recalcRow($(this).closest('tr'));
  });

  // ---- Inicialización: recalcular al iniciar ----
  $(function () {
    if ($.fn.DataTable && $.fn.DataTable.isDataTable(TABLE_ID)) {
      dtMeta = $(TABLE_ID).DataTable();
    }
    $(`${TABLE_ID} tbody tr`).each(function(){ recalcRow($(this)); });
  });

  // ---- Recalcular en cada draw de DataTables ----
  $(document).on('draw.dt', function(){
    if (SKIP_RECALC) return;
    $(`${TABLE_ID} tbody tr`).each(function(){ recalcRow($(this)); });
  });

  $(document).on('input', '.txt-valor-agregado', function(){
    const $tr   = $(this).closest('tr');
    const $meta = $tr.find('.meta-preliminar');
    const base  = toInt($meta.data('meta-base'));
    const delta = toInt($(this).val());
    const nuevo = base + delta;
    if (delta !== 0) $meta.addClass('font-weight-bold fs-5'); else $meta.removeClass('font-weight-bold fs-5');
    $meta.text(formatMiles(nuevo));
  });
    
  $(document).on('change', '.txt-valor-agregado', function(){
    if ($(this).val() === '') {
      const $tr   = $(this).closest('tr');
      const $meta = $tr.find('.meta-preliminar');
      const base  = toInt($meta.data('meta-base'));
      $meta.text(formatMiles(base)).removeClass('font-weight-bold fs-5');
    }
  });

  // ---- Guardado masivo ----
  $('#btnGuardarTodo').on('click', function(){
    const $btn=$(this);
    $btn.prop('disabled', true).text('Guardando...');

    const items = [];
    const nodes = ($.fn.DataTable && dtMeta) ? dtMeta.rows({search:'applied'}).nodes() : $(`${TABLE_ID} tbody tr`);

    $(nodes).each(function(){
      const $tr    = $(this);
      const pk     = $tr.data('pk');
      if(!pk) return;

      const $valor = $tr.find('.txt-valor-agregado');
      const $opj   = $tr.find('.txt-meta-opj');

      const opEgre = $tr.find('.chk-op-egre').is(':checked');
      const opIng  = $tr.find('.chk-op-ing').is(':checked');
      const opPend = $tr.find('.chk-op-pend').is(':checked');

      const deltaNum = toInt($valor.val());
      const opjRaw   = $opj.val();
      const opjNum   = (opjRaw==='' || opjRaw===null) ? null : parseInt(opjRaw,10);
      const n_opj    = (opjNum===null || isNaN(opjNum)) ? null : opjNum;

      items.push({
        pk: pk,
        n_valor_modificado: deltaNum,
        n_meta_opj: n_opj,
        flags: {
          m_op_egre_otra_dep: opEgre,
          m_op_ing_otra_dep:  opIng,
          m_op_pend_reserva:  opPend,
        }
      });
    });

    if(!items.length){
      swalInfo('No se encontraron filas.', 'Sin filas visibles');
      $btn.prop('disabled', false).text('Guardar todo');
      return;
    }

    $.ajax({
      url: "{% url 'est:meta_resumen_guardar_bulk' %}",
      method: "POST",
      data: JSON.stringify({items}),
      contentType: "application/json; charset=utf-8",
      headers: {"X-CSRFToken": csrftoken},
    }).done(function(resp){
      if (resp.ok && resp.resultados) {
        let errores = 0;
        SKIP_RECALC = true;

        resp.resultados.forEach(r => {
          if (!r.ok) { errores++; return; }

          const $row = $(`${TABLE_ID} tbody tr[data-pk='${r.pk}']`);

          // Actualiza inputs
          const $va  = $row.find('.txt-valor-agregado');
          const $opj = $row.find('.txt-meta-opj');
          if ($va.length)  $va.val(r.n_valor_modificado ?? '');
          if ($opj.length) $opj.val(r.n_meta_opj ?? '');

          // Pintar valores del backend
          $row.find('.td-ing-proy')
              .text(formatMiles(r.m_ing_proyectado))
              .data('prev', r.m_ing_proyectado);
          $row.find('.td-carga')
              .text(formatMiles(r.m_carg_procesal_tram))
              .data('prev', r.m_carg_procesal_tram);

          // Refrescar bases de BD (para switches OFF)
          $row.attr('data-ingproy-bd', r.m_ing_proyectado);
          $row.attr('data-carga-bd',   r.m_carg_procesal_tram);

          // Febrero_total usado por el backend (opcional)
          if (typeof r.ingreso_mes_actual !== 'undefined' && r.ingreso_mes_actual !== null) {
            $row.attr('data-febrero-bd', r.ingreso_mes_actual);
            if (DEBUG) console.log(`[MetaResumen] pk=${r.pk} :: m_t_ingreso_mes (backend)=`, r.ingreso_mes_actual);
          }

          // Meta preliminar y situación
          const $meta = $row.find('.meta-preliminar');
          $meta.text(formatMiles(r.m_meta_preliminar))
               .attr('data-meta-base', r.m_meta_preliminar)
               .removeClass('font-weight-bold fs-5');

          const $sit = $row.find('.td-situacion');
          if ($sit.length) {
            $sit.removeClass('bg-danger bg-success bg-warning text-white')
                .text(r.x_situacion_carga);
            if (r.x_situacion_carga === 'SOBRECARGA') $sit.addClass('bg-danger text-white');
            else if (r.x_situacion_carga === 'SUBCARGA') $sit.addClass('bg-success text-white');
            else if (r.x_situacion_carga === 'ESTANDAR') $sit.addClass('bg-warning');
          }

          // ---- LOG de depuración desde backend (si enviaste 'debug' en la respuesta)
          if (r.debug) {
            console.groupCollapsed(`Dato Guardado de pk=${r.pk}`);
            console.log('Avance de Meta =', r.debug.avan);
            console.log('Nivel de Produccion =', r.debug.x_niv_produc);
            console.log('Cantidad de Expedientes para Nivel Bueno =', r.debug.m_niv_bueno_nuevo);
            console.log('Cantidad de Expedientes para Nivel Muy Bueno =', r.debug.m_niv_muy_bueno_nuevo);
            console.log('Ingreso Febrero Total =', r.debug.febrero_total);
            console.log('numerador =', r.debug.numerador);
            console.log('Mes Actual sin Febrero =', r.debug.MES_ACTUAL_SIN_FEB);
            console.log('Meses Falta =', r.debug.MESES_FALTA);
            console.log("Total de Resueltos = ", r.debug.total_resuelto_mes);
            console.log("Meta Preliminar Nueva = ", r.debug.m_meta_preliminar_nueva);
            console.log("m_ideal_avan_meta_ant =", r.debug.m_ideal_avan_meta_ant);
            console.log("m_ideal_avan_meta ="    , r.debug.m_ideal_avan_meta);
            console.groupEnd();
          } else {
            // Si no envías 'debug', usa los campos "normales" de la respuesta
            console.groupCollapsed(`[GuardarBulk] pk=${r.pk}`);
            console.log('avan =', r.m_avan_meta);        // string en %
            console.log('x_niv_produc =', r.x_niv_produc);
            console.log('m_niv_bueno_nuevo =', r.m_niv_bueno);
            console.log('m_niv_muy_bueno_nuevo =', r.m_niv_muy_bueno);
            console.groupEnd();
          }
        });

        setTimeout(()=> { SKIP_RECALC = false; }, 40);

        // Recalcular nuevamente tras pintar backend (opcional)
        $(`${TABLE_ID} tbody tr`).each(function(){ recalcRow($(this)); });

        if (errores) {
          Swal.fire({
            icon: 'warning',
            title: 'Guardado con restricciones',
            text: `Se omitieron ${errores} fila(s) no editables.`
          });
        } else {
          Swal.fire({
            icon: 'success',
            title: 'Guardado masivo OK',
            text: 'Cambios aplicados correctamente.',
            timer: 2000,
            showConfirmButton: false
          });
        }
      } else {
        swalErr('No se pudo guardar. Intenta nuevamente.', 'Error al guardar');
      }
    }).fail(function(){
      swalErr('Verifica tu conexión e inténtalo de nuevo.', 'Error de comunicación');
    }).always(function(){
      $btn.prop('disabled', false).text('Guardando...');
      $btn.text('Guardar todo');
    });
  });
</script>
{% endblock %}






