{% extends "base/base.html" %}
{% load static %}

{% block title %}Estadística por Organo Jurisdiccional :: Estadistica{% endblock  %}
{% block title_nav %}Estadística por Organo Jurisdiccional{% endblock  %}



{% block extra_css %}
<link rel="stylesheet" href="{% static 'base/vendor/fonts/tabler-icons.css' %}" />
<link rel="stylesheet" href="{% static 'base/vendor/fonts/flag-icons.css' %}" />
<link rel="stylesheet" href="{% static 'base/css/cards-advance.css' %}" />
{% endblock  %}

{% block select_css %}
<link rel="stylesheet" href="{% static 'base/vendor/bootstrap-select/bootstrap-select.css' %}" />
<link rel="stylesheet" href="{% static 'base/vendor/select2/select2.css' %}" />
<link rel="stylesheet" href="{% static 'base/vendor/form-validation/form-validation.css' %}" />
{% endblock  %}

{% block body_container %}
    <div class="container-xxl flex-grow-1 container-p-y pt-5">

      {% if perms.est.list_mae_est_modulos or perms.est.list_mov_est_modulo_usuarios %}
        <div class="modal fade" id="modalProductividad" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="modalCenterTitle">Información Nivel de Productividad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>

              <div class="modal-body">
                <div class="row">
                  <div class="col-12 mb-2">
                    <button type="button" class="btn rounded-pill btn-danger">BAJO</button> Si el nivel de productividad esta entre 0 y 74 Bajo 
                  </div>

                  <div class="col-12 mb-2">
                    <button type="button" class="btn rounded-pill btn-warning">BUENO</button> Si el nivel de productividad esta entre 75 y 87 
                  </div>

                  <div class="col-12">
                    <button type="button" class="btn rounded-pill btn-success">MUY BUENO</button> Si el nivel de productividad esta entre 88 a más
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal fade" id="modalEstandar" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content ">
              <div class="modal-header">
                <h5 class="modal-title" id="modalCenterTitle">Información Nivel de Productividad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>

              <div class="modal-body">
                <div class="row">
                  <div class="col-12 mb-2">
                    <table class="table table-bordered">
                      <thead>
                        <th>Condición</th>
                        <th>Observación</th>
                        <th>Situación</th>
                      </thead>

                      <tbody>
                        <tr>
                          <td>Carga Procesal < Carga Procesal Minima Anual</td>
                          <td>Meta Preliminar = 77% de la Carga Procesal Anual (*)</td>
                          <td><button type="button" class="btn rounded-pill btn-success">SUBCARGA</button></td>
                        </tr>

                        <tr>
                          <td>Carga Procesal Mínima Anual <= Carga procesal Anual <= Carga Procesal Máxima Anual</td>
                          <td>Meta Preliminar = Estandar de Producción</td>
                          <td><button type="button" class="btn rounded-pill btn-warning">ESTANDAR</button></td>
                        </tr>

                        <tr>
                          <td>Carga Procesal Anual > Carga Procesal Máxima Anual</td>
                          <td>Meta Preliminar = Estandar de Producción</td>
                          <td><button type="button" class="btn rounded-pill btn-danger">SOBRECARGA</button></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-6 pt-2">
          <div class="col-12">
            <div class="card">
              
              <div class="card-header pt-3 pb-2">
                <h3 class="font-weight-bold mb-1 pb-1">Buscar Organo Jurisdiccional:</h3>
              </div>

                <div class="card-body">
                  <div class="row">
                  <div class="col-xl-10 col-lg-6 col-md-7 col-sm-8 col-12 mb-3">
                    <select class="select2 form-control form-control-lg w-100" id="instanciaSelect">
                      <option value="">Seleccione un Organo Jurisdiccional</option>
                      {% for instancia in instancias %}
                          <option value="{{ instancia.n_instancia_id }}">{{ instancia.x_nom_instancia }}</option>
                      {% endfor %}
                    </select>
                  </div>

                  <div class="col-xl-2 col-lg-6 col-md-5 col-sm-4 col-12 d-grid">
                    <button id="buscarInstancia" type="button" class="btn btn-dark btn-lg">
                      <i class="ti ti-search ti-md"> </i> CONSULTAR
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="resultados">
        </div>
      {% endif %}
    </div>

{% endblock  %}

{% block datatable %}
{% endblock  %}

{% block script %} 
<script>
  $(document).ready(function() {
    $('#instanciaSelect').select2({
      placeholder: "Seleccione una instancia",
      allowClear: true
    });
  
    document.getElementById('buscarInstancia').addEventListener('click', function(event) {
      event.preventDefault();
  
      const instanciaId = document.getElementById('instanciaSelect').value;
  
      if (instanciaId) {
        fetch(`datos/?instancia_id=${instanciaId}`, {
          headers: {
            "X-Requested-With": "XMLHttpRequest",
          },
        })
        .then(response => response.json())
        .then(data => {
          const resultadosDiv = document.getElementById('resultados');
          resultadosDiv.innerHTML = '';
  
          if (data.datos && data.datos.length > 0) {
            data.datos.forEach((item, index) => {
              const canvasId = `graficoIngresosResueltos_${index}`;
                    resultadosDiv.innerHTML += `
                    <div class="card mt-3">
                      <div class="card-header">
                        <h3 class="card-tittle font-weight-bold text-center p-0 m-0">${item.n_instancia__x_nom_instancia}</h3>
                        <div class="text-center"><span class="font-weight-bold">Información:</span> De 01 de Enero 2025 hasta ${item.f_fecha_mod}</div>
                      </div>

                      <div class="card-body">
                        <div class="row">
                          <div class="col-xxl-4 col-xl-4 col-lg-6 col-md-6 col-sm-12 col-12 mb-3">
                            ${
                              item.x_niv_produc === "MUY BUENO"
                                ? `
                                  <div class="card card-border-shadow-success">
                                    <div class="d-flex align-items-center row">
                                      <div class="col-7">
                                        <div class="card-body mt-0 text-nowrap">
                                          <h5 class="card-title mb-0 mt-0 text-dark font-weight-bold">NIVEL DE PRODUCTIVIDAD</h5>
                                          <h4><span class="badge bg-success ">${item.x_niv_produc}</span></h4> 
                                          <a data-bs-toggle="modal"
                                          data-bs-target="#modalProductividad" class="mt-0 pt-2">Más Información</a>
                                        </div>
                                      </div>
    
                                      <div class="col-5 d-flex align-items-start">
                                        <div class="card-body d-flex align-items-start pt-0 mt-0">
                                          <img src="{% static "base/img/Svg/medalla.svg" %}" height="140" alt="medalla" />
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                `
                                :
                                item.x_niv_produc === "BUENO"
                                ?`
                                  <div class="card card-border-shadow-warning">
                                    <div class="d-flex align-items-center row">
                                      <div class="col-7">
                                        <div class="card-body mt-0 text-nowrap">
                                          <h5 class="card-title mb-0 mt-0 text-dark font-weight-bold">NIVEL DE PRODUCTIVIDAD</h5>
                                          <h4><span class="badge bg-warning text-dark">${item.x_niv_produc}</span></h4>
                                          <a data-bs-toggle="modal"
                                    data-bs-target="#modalProductividad" class="mt-0 pt-2">Más Información</a>
                                        </div>
                                      </div>
    
                                      <div class="col-5 d-flex align-items-start">
                                        <div class="card-body d-flex align-items-start pt-0 mt-0">
                                          <img src="{% static "base/img/Svg/medalla_plata.svg" %}" height="140" alt="medalla" />
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                `
                                :
                                `
                                  <div class="card card-border-shadow-danger">
                                    <div class="d-flex align-items-center row">
                                      <div class="col-7">
                                        <div class="card-body mt-0 text-nowrap">
                                          <h5 class="card-title mb-0 mt-0 text-dark font-weight-bold">NIVEL DE PRODUCTIVIDAD</h5>
                                          <h4><span class="badge bg-danger">${item.x_niv_produc}</span></h4>
                                          <a data-bs-toggle="modal"
                                          data-bs-target="#modalProductividad" class="mt-0 pt-2">Más Información</a>
                                        </div>
                                      </div>
    
                                      <div class="col-5 d-flex align-items-start">
                                        <div class="card-body d-flex align-items-start pt-0 mt-0">
                                          <img src="{% static "base/img/Svg/medalla_bronce.svg" %}" height="140" alt="medalla" />
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                `
                            }
                          </div>

                          <div class="col-xxl-4 col-xl-4 col-lg-6 col-md-6 col-sm-12 col-12 mb-3">
                            ${
                              item.IER >= 90
                                ? `
                                  <div class="card card-border-shadow-success">
                                    <div class="row  d-flex align-items-center">
                                      <div class="col-7">
                                          <h5 class="mb-0 mt-0 text-center text-dark font-weight-bold">Indicador de Expedientes Resueltos (IER)</h5>
                                          <h4 class="text-center"><span class="badge bg-success">${item.IER}%</span></h4>
                                      </div>
    
                                      <div class="col-5 d-flex align-items-center justify-content-center">
                                        <div class="card-body d-flex align-items-center pt-0 mt-0">
                                          <img src="{% static "base/img/Svg/subcarga.svg" %}" height="140" alt="medalla" class="pt-5"/>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                `
                                :
                                item.IER >= 50
                                ?`
                                  <div class="card card-border-shadow-warning">
                                    <div class="row  d-flex align-items-center">
                                      <div class="col-7">
                                          <h5 class="mb-0 mt-0 text-center text-dark font-weight-bold">Indicador de Expedientes Resueltos (IER)</h5>
                                          <h4 class="text-center"><span class="badge bg-warning">${item.IER}%</span></h4>
                                      </div>
    
                                      <div class="col-5 d-flex align-items-center justify-content-center">
                                        <div class="card-body d-flex align-items-center pt-0 mt-0">
                                          <img src="{% static "base/img/Svg/estandar.svg" %}" height="140" alt="medalla" class="pt-5"/>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                `
                                :
                                `
                                  <div class="card card-border-shadow-danger">
                                    <div class="row  d-flex align-items-center">
                                      <div class="col-7">
                                          <h5 class="mb-0 mt-0 text-center text-dark font-weight-bold">SITUACIÓN DE LA CARGA EN TRÁMITE</h5>
                                          <h4 class="text-center"><span class="badge bg-danger">${item.IER}%</span></h4>
                                      </div>
    
                                      <div class="col-5 d-flex align-items-center justify-content-center">
                                        <div class="card-body d-flex align-items-center pt-0 mt-0">
                                          <img src="{% static "base/img/Svg/sobrecarga.svg" %}" height="140" alt="medalla" class="pt-5"/>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                `
                            }
                          </div>
    
                          <div class="col-xxl-4 col-xl-4 col-lg-6 col-md-6 col-sm-12 col-12 mb-3">
                            ${
                              item.x_situacion_carga === "SUBCARGA"
                              ? `
                                <div class="card card-border-shadow-success">
                                  <div class="row  d-flex align-items-center">
                                    <div class="col-7">
                                        <h5 class="mb-0 mt-0 text-center text-dark font-weight-bold">SITUACIÓN DE LA CARGA EN TRÁMITE</h5>
                                        <h4 class="text-center"><span class="badge bg-success">${item.x_situacion_carga}</span></h4>
                                        <a data-bs-toggle="modal"
                            data-bs-target="#modalEstandar" class="mt-0 pt-2 text-center">Más Información</a>
                                    </div>
  
                                    <div class="col-5 d-flex align-items-center justify-content-center">
                                      <div class="card-body d-flex align-items-center pt-0 mt-0">
                                        <img src="{% static "base/img/Svg/verde_subcarga.svg" %}" height="140" alt="medalla" class="pt-5"/>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              `
                              :
                              item.x_situacion_carga === "ESTANDAR"
                              ?`
                                <div class="card card-border-shadow-warning">
                                  <div class="row  d-flex align-items-center">
                                    <div class="col-7">
                                        <h5 class="mb-0 mt-0 text-center text-dark font-weight-bold">SITUACIÓN DE LA CARGA EN TRÁMITE</h5>
                                          <h4 class="text-center"><span class="badge bg-warning">${item.x_situacion_carga}</span></h4>
                                          <a data-bs-toggle="modal"
                            data-bs-target="#modalEstandar" class="mt-0 pt-2 text-center">Más Información</a>
                                    </div>
  
                                    <div class="col-5 d-flex align-items-center justify-content-center">
                                      <div class="card-body d-flex align-items-center pt-0 mt-0">
                                        <img src="{% static "base/img/Svg/ama_estandar.svg" %}" height="100" alt="medalla" class="pt-5"/>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              `
                              :
                              `
                                <div class="card card-border-shadow-danger">
                                  <div class="row  d-flex align-items-center">
                                    <div class="col-7">
                                        <h5 class="mb-0 mt-0 text-center text-dark font-weight-bold">Situación de Carga en Trámite</h5>
                                          <h4 class="text-center"><span class="badge bg-danger">${item.x_situacion_carga}</span></h4>
                                          <a data-bs-toggle="modal"
                            data-bs-target="#modalEstandar" class="mt-0 pt-2 text-center">Más Información</a>
                                    </div>
  
                                    <div class="col-5 d-flex align-items-center justify-content-center">
                                      <div class="card-body d-flex align-items-center pt-1 mt-0">
                                        <img src="{% static "base/img/Svg/rojo_sobrecarga.svg" %}" height="140" alt="medalla" class="pt-5"/>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              `
                            }
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="card mt-3">
                      <div class="card-header">
                        <h5 class="card-tittle font-weight-bold p-0 m-0">METAS Y AVANCE</h5>
                      </div>

                      <div class="card-body pb-0">
                        <div class="row">
                          <div class="col-xxl-5 col-lg-5 col-md-12 mb-6 mt-3 pr-3">
                            <ul class="p-0 m-0">
                              <li class="mb-6 d-flex justify-content-between align-items-center">
                                <div class="badge bg-label-dark rounded p-1_5"><i class="ti ti-star ti-md"></i></div>
                                <div class="d-flex justify-content-between w-100 flex-wrap">
                                  <h5 class="mb-0 ms-4">Estándar de Producción</h5>
                                  <div class="d-flex">
                                    <h5 class="mb-0">${item.m_estandar_prod}</h5>
                                  </div>
                                </div>
                              </li>
                              <li class="mb-6 d-flex justify-content-between align-items-center">
                                <div class="badge bg-label-dark rounded p-1_5"><i class="ti ti-target-arrow ti-md"></i></div>
                                <div class="d-flex justify-content-between w-100 flex-wrap">
                                  <h5 class="mb-0 ms-4">Meta Proyectada</h5>
                                  <div class="d-flex">
                                    <h5 class="mb-0">${item.m_meta_preliminar}</h5>
                                  </div>
                                </div>
                              </li>
                              <li class="mb-6 d-flex justify-content-between align-items-center">
                                <div class="badge bg-label-dark rounded p-1_5"><i class="ti ti-books ti-md"></i></div>
                                <div class="d-flex justify-content-between w-100 flex-wrap">
                                  <h5 class="mb-0 ms-4">Carga Procesal Inicial (01-Ene-2025)</h5>
                                  <div class="d-flex">
                                    <h5 class="mb-0">${item.n_carg_procesal_ini}</h5>
                                  </div>
                                </div>
                              </li>
                              <li class="mb-6 d-flex justify-content-between align-items-center">
                                <div class="badge bg-label-dark rounded p-1_5"><i class="ti ti-file ti-md"></i></div>
                                <div class="d-flex justify-content-between w-100 flex-wrap">
                                  <h5 class="mb-0 ms-4">Total de Expedientes Ingresados</h5>
                                  <div class="d-flex">
                                    <h5 class="mb-0">${item.m_t_ingreso}</h5>
                                  </div>
                                </div>
                              </li>
                              <li class="mb-6 d-flex justify-content-between align-items-center">
                                <div class="badge bg-label-dark rounded p-1_5"><i class="ti ti-file-check ti-md"></i></div>
                                <div class="d-flex justify-content-between w-100 flex-wrap">
                                  <h5 class="mb-0 ms-4">Total de Expedientes Resueltos</h5>
                                  <div class="d-flex">
                                    <h5 class="mb-0">${item.m_t_resuelto}</h5>
                                  </div>
                                </div>
                              </li>
                            </ul>
                          </div>

                          <div class="col-xxl-6 col-lg-6 col-md-12 offset-xxl-1 offset-lg-1 mb-2 pl-3">
                            <canvas id="${canvasId}" width="500" height="200"></canvas>
                          </div>  
                        </div>
                      </div>
                    </div>

                    <div class="card mt-3">
                      <div class="card-header">
                        <h5 class="card-tittle mb-0 p-2">PORCENTAJE DE AVANCE</h5>
                      </div>

                      <div class="card-body">
                        <div class="row">
                          <div class="col-6">
                            <div class="d-flex justify-content-between align-items-center gap-3">
                              <h5 class="mb-0">% Ideal de Avance de Meta Redondeado</h5>
                              <h5 class="text-muted mb-0">${item.m_ideal_avan_meta}%</h5>
                            </div>
                            <div class="d-flex align-items-center mt-1 mb-2">
                              <div class="progress w-100" style="height: 8px">
                                <div
                                  class="progress-bar bg-dark"
                                  style="width: ${item.m_ideal_avan_meta}%"
                                  role="progressbar"
                                  aria-valuenow="${item.m_ideal_avan_meta}%"
                                  aria-valuemin="0"
                                  aria-valuemax="100">
                                </div>
                              </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center gap-3 pt-2">
                              <h5 class="mb-0">% Real de Avance de Meta</h5>
                              <h5 class="text-muted mb-0">${item.m_avan_meta}%</h5>
                            </div>
                            
                            <div class="d-flex align-items-center mt-1">
                              <div class="progress w-100" style="height: 8px">
                                <div
                                  class="progress-bar bg-info"
                                  style="width: ${item.m_avan_meta}%"
                                  role="progressbar"
                                  aria-valuenow="${item.m_avan_meta}"
                                  aria-valuemin="0"
                                  aria-valuemax="100">
                                </div>
                              </div>
                            </div>
                          </div>

                          <div class="col-lg-3 col-sm-12">
                            <div class="card card-border-shadow-info h-100">
                              <div class="card-body">
                                <div class="d-flex align-items-center mb-2">
                                  <h3 class="mb-0">${item.m_niv_bueno}</h3>
                                </div>
                                <h5 class="mb-1">Cantidad de Expedientes para Alcanzar el N.P. "BUENO"</h5>
                              </div>
                            </div>
                          </div>

                          <div class="col-lg-3 col-sm-12">
                            <div class="card card-border-shadow-info h-100">
                              <div class="card-body">
                                <div class="d-flex align-items-center mb-2">
                                  <h3 class="mb-0">${item.m_niv_muy_bueno}</h3>
                                </div>
                                <h5 class="mb-1">Cantidad de Expedientes para Alcanzar el N.P. "MUY BUENO"</h5>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    `;
                    
                    // Generar gráfico con Chart.js
                    setTimeout(() => {
                      const ctx = document.getElementById(canvasId).getContext('2d');
                      new Chart(ctx, {
                        type: 'bar',
                        data: {
                          labels: ['Expedientes Ingresados', 'Expedientes Resueltos'],
                          datasets: [{
                            label: 'Expedientes',
                            data: [item.m_t_ingreso, item.m_t_resuelto],
                            backgroundColor: ['#4e73df', '#1cc88a']
                          }]
                        },
                        options: {
                          indexAxis: 'x', // ← Esto convierte la gráfica en horizontal
                          responsive: true,
                          plugins: {
                            legend: { display: false },
                            title: {
                              display: true,
                              text: 'Gráfica de Expedientes Totales Ingresados vs Totales Resueltos'
                            },
                            datalabels: {
                              anchor: 'center',
                              align: 'center',
                              color: '#fff',
                              font: {
                                weight: 'bold',
                                size: 16
                              },
                              formatter: Math.round
                            }
                          },
                          scales: {
                            x: {
                              beginAtZero: true
                            }
                          }
                        },
                        plugins: [ChartDataLabels] 
                      });
                    }, 100);

                  });
                } else {
                  resultadosDiv.innerHTML = '<div class="alert alert-info">No se encontraron resultados.</div>';
              }
            });
          }
        });
      });
    </script>

{% endblock %}

    {% block form_js %}
    <script src="{% static 'base/vendor/bootstrap-select/bootstrap-select.js' %}"></script>
    <script src="{% static 'base/vendor/select2/select2.js' %}"></script>
    <script src="{% static 'base/vendor/form-validation/popular.js' %}"></script>
    <script src="{% static 'base/vendor/form-validation/bootstrap5.js' %}"></script>
    <script src="{% static 'base/vendor/form-validation/auto-focus.js' %}"></script>
    {% endblock %}
