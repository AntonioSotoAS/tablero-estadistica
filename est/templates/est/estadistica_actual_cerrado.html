{% extends "base/base.html" %}
{% load static %}

{% block title %}M√≥dulos :: Estadistica{% endblock  %}
{% block title_nav %}{% endblock  %}

{% block grafico_css %}
<link rel="stylesheet" href="{% static 'base/vendor/apex-charts/apex-charts.css' %}" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock  %}

{% block body_container %}
    <style>
        /* Contenedor del gr√°fico */
        #chart-container {
            width: 100%;
            height: 60vh; /* Usa una altura relativa a la ventana para adaptarlo */
            max-height: 600px; /* M√°ximo para pantallas grandes */
        }
    </style>

    <section class="content">
        <div class="container-xxl flex-grow-1 container-p-y pt-5">
            {% if perms.est.list_mae_est_modulos or perms.est.list_mov_est_modulo_usuarios %}
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="nav-align-top nav-tabs-shadow mb-6">

                                {% comment "" %} =======================================
                                ======= CUERPO 01: GRAFICO POR PORCENTAJE ==============
                                ======================================= {% endcomment %}
                                <div class="tab-pane fade show active" id="navs-justified-home" role="tabpanel">
                                    <div class="col-lg-12 col-12">
                                    {% for jurisdiccion, instancias in agrupados.items %}

                                        <h3 class="text-center mt-5 mb-0 font-weight-bold">RANKING DE {{ jurisdiccion }}</h3>

                                        <div class="text-center mt-0 mb-3">
                                            <span class="font-weight-bold">Informaci√≥n:</span> Desde 01 de Enero hasta 
                                            <span class="font-weight-bold">{{ fecha_modificacion }}</span>
                                        </div>

                                        <div class="row g-4">
                                            <div class="col-12 col-lg-6 ">
                                                <div class="card border-0 shadow-sm h-100">                                    
                                                    <div class="card-body text-center">
                                                        <h4><span class="badge bg-info mb-3">Mes Actual </span><span class="badge bg-label-info">Escala Ideal: {{ meta_ideal_A }}%</span></h4>
                                                        
                                                        <div id="graficoEcharts_A_{{ forloop.counter }}" style="height: 600px;"></div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-12 col-lg-6">
                                                <div class="card border-0 shadow-sm h-100">

                                                    <div class="card-body text-center">
                                                        <h4><span class="badge bg-success mb-3">Mes Anterior Cerrado </span><span class="badge bg-label-success">Escala Ideal: {{ meta_ideal_C }}%</span></h4>
                                                        <div id="graficoEcharts_C_{{ forloop.counter }}" style="height: 600px;"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <script>
                                        document.addEventListener("DOMContentLoaded", function () {
                                        const instancias = {{ instancias|safe }};
                                        const META_IDEAL_A = parseFloat('{{ meta_ideal_A|default:"0" }}'); // mes actual
                                        const META_IDEAL_C = parseFloat('{{ meta_ideal_C|default:"0" }}'); // mes anterior (cerrado)

                                        const contA = document.getElementById('graficoEcharts_A_{{ forloop.counter }}');
                                        const contC = document.getElementById('graficoEcharts_C_{{ forloop.counter }}');

                                        const chartA = echarts.init(contA);
                                        const chartC = echarts.init(contC);

                                        function buildOption(dataFiltrado, metaIdealGlobal) {
                                            const labels = dataFiltrado.map(i => i.n_instancia__x_nom_instancia);
                                            const nombres_juez = dataFiltrado.map(i => i.juez_nombre || 'Sin juez asignado');
                                            const avance = dataFiltrado.map(i => parseFloat(i.m_avan_meta));
                                            const ideal  = dataFiltrado.map(i => parseFloat(i.m_ideal_avan_meta));

                                            const colores = avance.map((v, idx) => v < ideal[idx]
                                            ? 'rgba(255, 99, 132, 0.7)'   // rojo
                                            : 'rgba(75, 192, 192, 0.7)'   // verde
                                            );

                                            return {
                                            tooltip: {
                                                trigger: 'axis',
                                                axisPointer: { type: 'shadow' },
                                                formatter: function (params) {
                                                const idx = params[0].dataIndex;
                                                return `
                                                    üë®‚Äç‚öñÔ∏è <b>Juez:</b> ${nombres_juez[idx]}<br/>
                                                    üè¢ <b>${labels[idx]}</b><br/>
                                                    „ÄΩÔ∏è <b>Avance Real:</b> ${avance[idx]}%<br/>
                                                    üìä <b>Meta Ideal (instancia):</b> ${ideal[idx]}%
                                                `;
                                                }
                                            },
                                            grid: { left: '3%', right: 14, bottom: '6%', top: 28, containLabel: true },
                                            xAxis: { type: 'value', max: 100, axisLabel: { formatter: '{value}%' } },
                                            yAxis: {
                                                type: 'category',
                                                data: labels,
                                                axisLabel: {
                                                formatter: v => v.length > 28 ? v.slice(0, 28) + '‚Ä¶' : v,
                                                interval: 0
                                                }
                                            },
                                            series: [{
                                                name: '% Avance',
                                                type: 'bar',
                                                data: avance,
                                                itemStyle: {
                                                color: params => colores[params.dataIndex]
                                                },
                                                label: {
                                                show: true,
                                                position: 'insideRight',
                                                formatter: '{c}%',
                                                fontWeight: 'bold',
                                                color: 'rgb(0,0,0)'
                                                },
                                                // l√≠nea vertical de meta ideal GLOBAL (escala del mes)
                                                markLine: {
                                                symbol: 'none',
                                                lineStyle: { type: 'dashed', color: 'rgba(24, 85, 216, 0.8)' },
                                                label: {
                                                    position: 'end',
                                                    formatter: `Meta Ideal ${metaIdealGlobal}%`,
                                                    fontWeight: 'bold',
                                                    backgroundColor: 'rgba(34, 25, 167, 0.7)',
                                                    color: '#fff',
                                                    padding: 4
                                                },
                                                data: [{ xAxis: metaIdealGlobal }]
                                                }
                                            }]
                                            };
                                        }

                                        // Filtra por estado y ordena si lo necesitas
                                        const dataA = instancias.filter(i => i.estado === 'A');
                                        const dataC = instancias.filter(i => i.estado === 'C');

                                        chartA.setOption(buildOption(dataA, META_IDEAL_A));
                                        chartC.setOption(buildOption(dataC, META_IDEAL_C));

                                        // Responsivo
                                        window.addEventListener('resize', () => {
                                            chartA.resize();
                                            chartC.resize();
                                        });
                                        });
                                        </script>

                                    {% endfor %}
                                    </div>
                                </div>

                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </section>
{% endblock %}

{% block grafico_js %}
<script src="{% static 'base/vendor/apex-charts/apexcharts.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.3.1/decimal.min.js"></script>
<script src="{% static 'base/js/charts-chartjs.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
{% endblock %}

{% block script %}
<script>
    function mostrarDiaAnterior() {
        const ahora = new Date();  // Obtener la fecha actual
        const diaAnterior = new Date(ahora);  // Copiar la fecha actual
        diaAnterior.setDate(ahora.getDate() - 1);  // Restar un d√≠a

        // Formatear la fecha en espa√±ol
        const fechaFormateada = diaAnterior.toLocaleDateString("es-ES", {

            year: "numeric",
            month: "long",    // Mes en texto
            day: "numeric",
        });

        // Mostrar la fecha en el elemento con id 'fecha_anterior'
        document.getElementById('fecha_anterior').textContent = fechaFormateada;
    }

    // Llamar a la funci√≥n cuando la p√°gina cargue
    window.onload = mostrarDiaAnterior;


    /** =============================================================
    ======================= GR√ÅFICO CIRCULAR ========================
    ============================================================== */
    document.addEventListener("DOMContentLoaded", function () {
        const canvases = document.querySelectorAll(".progress-circle");
    
        canvases.forEach((canvas) => {
            const ctx = canvas.getContext("2d");
            const percentage = parseFloat(canvas.getAttribute("data-percentage")); // Ahora s√≠ obtiene el porcentaje
            const x_nivel_produc = canvas.getAttribute("data-nivel-produc"); // Obtiene el nivel de producci√≥n
    
            if (isNaN(percentage)) return; // Si no es un n√∫mero, no dibujar
    
            const radius = canvas.width / 2;
            const lineWidth = 15;
            const center = radius;
    
            ctx.lineWidth = lineWidth;
    
            // Dibuja el fondo del c√≠rculo
            ctx.beginPath();
            ctx.arc(center, center, radius - lineWidth, 0, 2 * Math.PI);
            ctx.strokeStyle = "#e6e6e6";
            ctx.stroke();
    
            // Determina el color del progreso
            let progressColor;
            switch (x_nivel_produc) {
                case "MUY BUENO":
                    progressColor = "#28a745"; // Verde
                    break;
                case "BUENO":
                    progressColor = "#ffc107"; // Amarillo
                    break;
                case "BAJO":
                    progressColor = "#f44336"; // Rojo
                    break;
                default:
                    progressColor = "#6c757d"; // Gris
            }
    
            // Dibuja el progreso
            const startAngle = -Math.PI / 2;
            const endAngle = startAngle + (percentage / 100) * 2 * Math.PI;
    
            ctx.beginPath();
            ctx.arc(center, center, radius - lineWidth, startAngle, endAngle);
            ctx.strokeStyle = progressColor;
            ctx.lineCap = "round";
            ctx.stroke();
        });
    });
    

</script>
{% endblock %}

